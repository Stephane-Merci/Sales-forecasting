{% extends 'base.html' %}

{% block title %}Data Analysis{% endblock %}

{% block main_classes %}
container-fluid h-100 px-0 py-0
{% endblock %}

{% block content %}
<div class="row h-100 no-gutters debug-border" style="height: 100%; margin: 0 !important;"> {# no-gutters to remove column padding #}
    <!-- Left Sidebar: Columns, Chart Settings, and Filters -->
    <div class="col-md-4 col-lg-3 bg-light border-right h-100 overflow-auto main-content-col"> {# Increased left sidebar width, added custom class #}
        <h5 class="mt-3 mb-3 px-3">Sales_Data_New</h5> {# Added horizontal padding #}

        <!-- Data Input/Upload Section -->
        <div class="px-3 py-3 mb-4 border rounded bg-white shadow-sm"> {# Added padding, border, rounded corners, background, and shadow #}
            <h6>Upload Data</h6>
            <div id="file-upload-area" class="form-group text-center p-4 border rounded bg-light cursor-pointer"> {# Added ID, text-center, padding, border, rounded, lighter background, and pointer cursor #}
                <div class="input-group" style="width: auto; display: inline-flex;"> {# Adjusted input group for centering #}
                    <input type="file" class="form-control d-none" id="data-upload-input" accept=".csv"> {# Added d-none to hide default input #}
                    <label class="btn btn-outline-primary" for="data-upload-input">Choose CSV File</label> {# Styled label as a button #}
                     {# Optional: Add a text indicator for drag and drop #}
                     <span class="ms-2 text-muted">or drag and drop file here</span>
                </div>
                 <small class="form-text text-muted mt-2 d-block">Supported format: CSV</small> {# Updated supported format and spacing #}
            </div>
        </div>

        <div class="row no-gutters px-3 mb-3"> {# Row for horizontal layout within sidebar, added bottom margin #}
            <!-- Data Columns List -->
            <div class="col-6 pe-2"> {# Takes half width, added right padding #}
                <h6>Columns</h6>
                <ul id="columns-list" class="list-group list-group-flush border rounded bg-white shadow-sm p-2"> {# Added border, rounded, background, shadow, padding #}
                    {# This list should be populated dynamically by JavaScript after data upload #}
                </ul>
                 {# Add a message when no columns are loaded #}
                 <p id="no-columns-message" class="text-muted mt-2 px-2 text-center">Upload data to see columns.</p>
            </div>

            <!-- Chart Settings / Column Mapping -->
            <div class="col-6 ps-2"> {# Takes other half width, added left padding #}
                <h6>Chart Settings</h6>
                
                {# Chart Type Selection #}
                <div class="mb-2">
                    <label for="chart-type-select" class="form-label form-label-sm">Chart Type</label>
                    <select class="form-select form-select-sm" id="chart-type-select">
                        <option value="line">Line Chart</option>
                        <option value="bar" selected>Bar Chart</option>
                        <option value="scatter">Scatter Plot</option>
                        <option value="pie">Pie Chart</option>
                         {# Add more chart types as needed #}
                    </select>
                </div>

                <div id="xaxis-dropzone" class="card mb-2 border rounded bg-white shadow-sm dropzone"> {# Added border, rounded, background, shadow #}
                    <div class="card-header">X Axis</div>
                    <div class="card-body p-2 text-muted text-center">
                        Drop here or click above
                        {# Area where dragged column names would appear #}
                    </div>
                </div>
                 <div id="yaxis-dropzone" class="card mb-2 border rounded bg-white shadow-sm dropzone"> {# Added border, rounded, background, shadow #}
                    <div class="card-header">Y Axis</div>
                    <div class="card-body p-2 text-muted text-center">
                        Drop here or click above
                        {# Area where dragged column names would appear #}
                    </div>
                </div>
                {# Add more settings like Break-Out, Row Limit, Sort, etc. as needed #}
            </div>
        </div> {# End row for horizontal layout #}

        <!-- Filters Section -->
         <div class="mb-4 px-3"> {# Added horizontal padding #}
            <h6>Filters</h6>
             <div id="filters-area" class="card mb-2 border rounded bg-white shadow-sm"> {# Added ID, border, rounded, background, shadow #}
                <div class="card-body p-2 text-muted">
                    <p class="text-center add-filter-btn">+ Add Filter</p> {# Made text clickable #}
                    {# Area for dynamically added filters #}
                    <div id="dynamic-filters-container"></div> {# Container for filters #}
                </div>
            </div>
         </div>

         {# Placeholder for other potential controls related to uploaded data #}

    </div>

    <!-- Right Content: Visualizations and Data View -->
    <div class="col-md-8 col-lg-9 h-100 d-flex flex-column main-content-col"> {# Adjusted width and added flex for content, added custom class #}
        <div class="d-flex justify-content-between align-items-center py-3 px-3 border-bottom"> {# Added padding and border #}
            <div>
                <button class="btn btn-outline-secondary me-2"><i class="fas fa-chart-bar"></i> Visualizations</button>
                <button class="btn btn-outline-secondary"><i class="fas fa-table"></i> Data View</button>
                 {# Buttons for Build, Format tabs #}
            </div>
            <div>
                {# Actions like Download, Run #}
                <button id="run-button" class="btn btn-primary me-2"><i class="fas fa-play"></i> Run</button>
                <button class="btn btn-secondary me-2"><i class="fas fa-download"></i> Download</button>
                {# More action buttons like View, Add to Dashboard #}
            </div>
        </div>

        <!-- Visualization/Data Area -->
        <div class="flex-grow-1 overflow-auto p-3"> {# flex-grow-1 to fill space, added padding #}
            {# This is where the chart or data table will be rendered by JavaScript #}
            <div id="visualization-area" class="text-center text-muted mt-5">
                <canvas id="myChart"></canvas>
            </div>

            {# Data View Area #}
            <div id="data-view-area" class="mt-3" style="display: none;">
                <table id="data-table" class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            {# Table headers will be added by JavaScript #}
                        </tr>
                    </thead>
                    <tbody>
                         {# Table rows will be added by JavaScript #}
                    </tbody>
                </table>
                <p id="no-data-view-message" class="text-muted text-center" style="display: none;">No data available to display.</p>
            </div>
        </div>

         <!-- Show Query / Jobs Area (Optional) -->
        <div class="border-top mt-auto p-2"> {# mt-auto to push to bottom #}
             <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="query-tab" data-bs-toggle="tab" data-bs-target="#query" type="button" role="tab" aria-controls="query" aria-selected="true">Show Query</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs" type="button" role="tab" aria-controls="jobs" aria-selected="false">Jobs</button>
                </li>
             </ul>
             <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="query" role="tabpanel" aria-labelledby="query-tab">
                    {# Display generated query here #}
                     <p class="mt-2 text-muted">Query will appear here after running.</p>
                </div>
                <div class="tab-pane fade" id="jobs" role="tabpanel" aria-labelledby="jobs-tab">
                     {# Display job status here #}
                     <p class="mt-2 text-muted">Job status will appear here.</p>
                </div>
             </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
/* Add custom styles here */
html, body, .container-fluid.h-100, .row.h-100 {
    height: 100%;
    overflow: hidden; /* Prevent main scrollbar */
}

.border-right {
    border-right: 1px solid #dee2e6;
}

.list-group-item i {
    cursor: grab;
}

.card-header {
    padding: 0.5rem 0.75rem;
    margin-bottom: 0;
    background-color: rgba(0, 0, 0, .03);
    border-bottom: 1px solid rgba(0, 0, 0, .125);
}

.card-body.p-2 {
    min-height: 50px; /* Ensure drag/drop areas have space */
}

.nav-tabs .nav-link.active {
    font-weight: bold;
}

/* Style for the visualization area placeholder */
#visualization-area {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%; /* Occupy remaining height */
    font-size: 1.2em;
}

/* Adjust list item background for better contrast against light background */
.list-group-item.bg-light {
    background-color: #f8f9fa !important;
}

.row.no-gutters {
    margin-left: 0;
    margin-right: 0;
}

.row.no-gutters > [class*="col-"] {
    padding-left: 0;
    padding-right: 0;
}

/* Ensure main container has no padding */
main.container-fluid.h-100.px-0.py-0 {
    padding: 0 !important;
    margin: 0 !important;
}

/* Remove padding from the main grid columns */
.main-content-col {
    padding: 0 !important;
}

/* Ensure the row inside main stretches full height */
main.container-fluid.h-100.px-0.py-0 > .row.h-100.no-gutters {
    height: 100%;
    margin: 0 !important; /* Ensure no margin */
}

/* Style for dropzone areas */
.dropzone {
    border: 2px dashed #ced4da;
    border-radius: 5px;
    cursor: pointer;
}

.dropzone .card-body {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 80px; /* Increased min-height for drop area */
}

/* Style for draggable columns */
.column-item {
    cursor: grab;
    white-space: nowrap; /* Prevent text from wrapping */
    overflow: hidden; /* Hide overflowing text */
    text-overflow: ellipsis; /* Display ellipsis for truncated text */
    margin-bottom: 4px; /* Add some space between items */
    border: 1px solid #e9ecef; /* Subtle border */
    border-radius: 4px; /* Slightly rounded corners */
}

.column-item:hover {
    background-color: #e2e6ea; /* Slightly darker background on hover */
}

/* Style for the add filter button */
.add-filter-btn {
    cursor: pointer;
    color: #0d6efd; /* Bootstrap primary color */
    text-decoration: none; /* Remove underline */
}

.add-filter-btn:hover {
    text-decoration: underline; /* Add underline on hover */
}

/* Custom style for the file upload area */
#file-upload-area {
    border: 2px dashed #ced4da; /* Dashed border */
    transition: all 0.3s ease; /* Smooth transition for hover effects */
}

#file-upload-area:hover {
    border-color: #0d6efd; /* Change border color on hover */
    background-color: #e9ecef; /* Slightly darker background on hover */
}

/* Style to hide the default file input button */
#data-upload-input {
    display: none;
}

</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.querySelectorAll('.btn-outline-secondary').forEach(button => {
    button.addEventListener('click', function() {
        const isVisualizationButton = this.textContent.includes('Visualizations');
        const visualizationArea = document.getElementById('visualization-area');
        const dataViewArea = document.getElementById('data-view-area');
        const noDataViewMessage = document.getElementById('no-data-view-message');
        const dataTable = document.getElementById('data-table');

        // Toggle active button style
        document.querySelectorAll('.btn-outline-secondary').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');

        if (isVisualizationButton) {
            visualizationArea.style.display = 'block';
            dataViewArea.style.display = 'none';
        } else {
            visualizationArea.style.display = 'none';
            dataViewArea.style.display = 'block';

            // Fetch and display data in the table when Data View is selected
            // Use the activeFilters to fetch the filtered data
            applyFilters(activeFilters)
                .then(result => {
                    console.log('Received filtered data for Data View:', result);
                    const previewData = result.preview;
                    const rowCount = result.row_count;

                    const thead = dataTable.querySelector('thead tr');
                    const tbody = dataTable.querySelector('tbody');

                    // Clear previous table content
                    thead.innerHTML = '';
                    tbody.innerHTML = '';
                    noDataViewMessage.style.display = 'none';

                    if (previewData && previewData.length > 0) {
                        // Create table headers from the keys of the first data object
                        const headers = Object.keys(previewData[0]);
                        headers.forEach(header => {
                            const th = document.createElement('th');
                            th.textContent = header;
                            thead.appendChild(th);
                        });

                        // Populate table body with data
                        previewData.forEach(rowData => {
                            const tr = document.createElement('tr');
                            headers.forEach(header => {
                                const td = document.createElement('td');
                                td.textContent = rowData[header];
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });

                        // Optionally display row count (e.g., below the table)
                        // For now, we just populate the table with preview data
                        console.log(`Total rows available: ${rowCount}`);

                    } else {
                        // Display no data message if previewData is empty
                        noDataViewMessage.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching data for Data View:', error);
                    // Optionally display an error message in the data view area
                    noDataViewMessage.style.display = 'block';
                    noDataViewMessage.textContent = `Error loading data: ${error.message}`;
                });
        }
    });
});

// Set Visualizations button as active by default on page load
document.querySelector('.btn-outline-secondary:first-of-type').classList.add('active');
// This is where you would add JavaScript for:
// - Building chart configurations based on selected columns and filter criteria
// - Making API calls to send data and configuration to the backend for processing/querying
// - Receiving processed data from the backend
// - Rendering charts using a charting library (e.g., Chart.js, Plotly.js, D3.js) in the visualization-area div
// - Switching between Visualization and Data View tabs
// - Handling Run and Download button clicks (Triggering data processing/download)
// - Displaying generated queries or job status (if applicable)

let availableColumns = []; // Variable to store parsed column headers
let activeFilters = []; // Array to store the configured filters

// Function to update the activeFilters array from the UI
function updateActiveFilters() {
    activeFilters = []; // Clear the array
    const filterRows = document.querySelectorAll('.filter-row');
    filterRows.forEach(row => {
        const columnSelect = row.querySelector('.filter-column-select');
        const operatorSelect = row.querySelector('.filter-operator-select');
        const valueInput = row.querySelector('.filter-value-input');

        const column = columnSelect.value;
        const operator = operatorSelect.value;
        const value = valueInput.value;

        // Only add filters that have at least a column selected
        if (column) {
            activeFilters.push({
                column: column,
                operator: operator,
                value: value
            });
        }
    });
    console.log('Active Filters:', activeFilters); // Log the current filters (for debugging)
}


// *** File Upload Handling ***
document.getElementById('data-upload-input').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const maxFileSize = 1 * 1024 * 1024; // 1MB in bytes

    if (file) {
        console.log('File selected:', file.name, 'Size:', file.size, 'bytes');

        // Check file size
        if (file.size > maxFileSize) {
            alert('File size exceeds the 1MB limit.');
            event.target.value = ''; // Clear the file input
            console.log('File size exceeds limit, upload cancelled.');
            return; // Stop further processing
        }

        const formData = new FormData();
        formData.append('file', file);

        // Send file to backend for processing
        fetch('/business/api/upload-data/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                console.log('Data loaded successfully:', result.data);

                // Store column information as array of objects {name, type}
                availableColumns = Object.keys(result.data.column_types).map(columnName => ({
                    name: columnName,
                    type: result.data.column_types[columnName]
                }));

                // Update columns list
                const columnsList = document.getElementById('columns-list');
                const noColumnsMessage = document.getElementById('no-columns-message');

                columnsList.innerHTML = ''; // Clear existing columns

                availableColumns.forEach(column => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center bg-light column-item';
                    li.setAttribute('draggable', true);
                    li.dataset.type = column.type; // Store column type on the element (optional now but good practice)
                    li.dataset.column = column.name; // Store column name on the element
                    li.innerHTML = `
                        ${column.name}
                        <i class="fas fa-grip-vertical text-muted"></i>
                    `;
                    columnsList.appendChild(li);
                });

                if (availableColumns.length > 0) {
                    noColumnsMessage.style.display = 'none';
                    document.querySelector('.add-filter-btn').style.pointerEvents = 'auto';
                    document.querySelector('.add-filter-btn').style.opacity = '1';
                } else {
                    noColumnsMessage.style.display = 'block';
                    noColumnsMessage.textContent = 'No columns found in file.';
                    document.querySelector('.add-filter-btn').style.pointerEvents = 'none';
                    document.querySelector('.add-filter-btn').style.opacity = '0.5';
                }

                enableDragAndDrop();
                toggleDropzonesVisibility(); // Update dropzones visibility based on default chart type

            } else {
                console.error('Error loading data:', result.message);
                alert('Error loading data: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error uploading file: ' + error.message);
        });
    }
});

// Function to get column statistics
function getColumnStats(column) {
    return fetch('/business/api/column-stats/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ column: column })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            return result.data;
        } else {
            throw new Error(result.message);
        }
    });
}

// Function to get visualization data
function getVisualizationData(xAxis, yAxis, category = null, filters = []) {
    return fetch('/business/api/visualization-data/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            x_axis: xAxis,
            y_axis: yAxis,
            category: category,
            filters: filters
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            return result.data;
        } else {
            throw new Error(result.message);
        }
    });
}

// Function to apply filters
function applyFilters(filters) {
    return fetch('/business/api/apply-filters/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filters: filters })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            return result.data;
        } else {
            throw new Error(result.message);
        }
    });
}

// *** Drag and Drop Functionality ***
function enableDragAndDrop() {
    const columnItems = document.querySelectorAll('.column-item');
    const dropzones = document.querySelectorAll('.dropzone');

    columnItems.forEach(item => {
        item.addEventListener('dragstart', (event) => {
            event.dataTransfer.setData('text/plain', event.target.textContent.trim());
            console.log('Dragging:', event.target.textContent.trim());
        });
    });

    dropzones.forEach(dropzone => {
        dropzone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropzone.classList.add('drag-over');
        });

        dropzone.addEventListener('dragleave', (event) => {
            dropzone.classList.remove('drag-over');
        });

        dropzone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropzone.classList.remove('drag-over');

            const columnName = event.dataTransfer.getData('text/plain');
            console.log('Dropped:', columnName, 'on', dropzone.id);

            const cardBody = dropzone.querySelector('.card-body');
            if (cardBody) {
                cardBody.textContent = columnName;
                dropzone.dataset.column = columnName;
            }

             // --- Next Steps ---
             // 1. Update chart configuration based on the dropped column
             // 2. Potentially update the UI to show the selected column clearly
        });

        // Add click listener to clear dropzone content
        dropzone.addEventListener('click', function() {
            if (this.dataset.column) { // Check if a column is currently in the dropzone
                this.querySelector('.card-body').textContent = 'Drop here or click above'; // Reset text
                this.dataset.column = ''; // Clear stored column name
                console.log('Cleared dropzone:', this.id);
                 // Optional: Trigger a chart update or clear the chart if needed after clearing
            }
        });
    });

     // Optional: Add styling for drag-over state
     const style = document.createElement('style');
     style.innerHTML = `
         .dropzone.drag-over {
             background-color: #e9ecef; /* Light gray background */
             border-color: #0d6efd; /* Primary color border */
         }
     `;
     document.head.appendChild(style);
}

// Update the filter functionality to use the backend API
document.querySelector('.add-filter-btn').addEventListener('click', function() {
    const filtersContainer = document.getElementById('dynamic-filters-container');

    // Create a new filter row element
    const filterRow = document.createElement('div');
    filterRow.className = 'filter-row mb-2';

    // Basic structure for a filter
    filterRow.innerHTML = `
        <div class="input-group">
            <select class="form-select form-select-sm filter-column-select">
                 <option value="" selected disabled>Select Column</option>
            </select>

            <select class="form-select form-select-sm filter-operator-select" disabled>
                 <option value="" selected disabled>Operator</option>
            </select>

            <input type="text" class="form-control form-select-sm filter-value-input" placeholder="Value" disabled>

            <button class="btn btn-outline-danger btn-sm remove-filter-btn" type="button">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    filtersContainer.appendChild(filterRow);

    // Populate the column select dropdown
    const columnSelect = filterRow.querySelector('.filter-column-select');
    availableColumns.forEach(column => {
        const option = document.createElement('option');
        option.value = column.name;
        option.textContent = column.name;
        columnSelect.appendChild(option);
    });

    // Enable operator and value inputs when a column is selected
    columnSelect.addEventListener('change', function() {
        const selectedColumn = this.value;
        const operatorSelect = filterRow.querySelector('.filter-operator-select');
        const valueInput = filterRow.querySelector('.filter-value-input');

        if (selectedColumn) {
            // Get column statistics to determine appropriate operators
            getColumnStats(selectedColumn)
                .then(stats => {
                    // Clear existing operator options
                    operatorSelect.innerHTML = '';
                    const defaultOperatorOption = document.createElement('option');
                    defaultOperatorOption.value = "";
                    defaultOperatorOption.textContent = "Select Operator";
                    defaultOperatorOption.selected = true;
                    defaultOperatorOption.disabled = true;
                    operatorSelect.appendChild(defaultOperatorOption);

                    // Add operators based on column type
                    // Find the type of the selected column from availableColumns
                    const selectedColInfo = availableColumns.find(col => col.name === selectedColumn);
                    const columnType = selectedColInfo ? selectedColInfo.type : 'categorical'; // Default to categorical if type not found

                    let operators = [];
                    
                    if (columnType === 'numeric') {
                        operators = ['==', '!=', '>', '<', '>=', '<=', 'between'];
                    } else if (columnType === 'datetime') {
                        operators = ['==', '!=', '>', '<', '>=', '<=', 'between'];
                    } else {  // categorical
                        operators = ['==', '!=', 'contains', 'starts with', 'ends with'];
                    }

                    operators.forEach(operator => {
                        const option = document.createElement('option');
                        option.value = operator;
                        option.textContent = operator;
                        operatorSelect.appendChild(option);
                    });

                    operatorSelect.disabled = false;
                    valueInput.disabled = false;
                })
                .catch(error => {
                    console.error('Error getting column stats:', error);
                    alert('Error getting column statistics: ' + error.message);
                });
        } else {
            operatorSelect.disabled = true;
            valueInput.disabled = true;
            operatorSelect.value = '';
            valueInput.value = '';
        }
        updateActiveFilters();
    });

    // Add event listener to the remove button
    filterRow.querySelector('.remove-filter-btn').addEventListener('click', function() {
        filterRow.remove();
        updateActiveFilters();
    });

    // Add event listeners to operator and value inputs
    filterRow.querySelector('.filter-operator-select').addEventListener('change', updateActiveFilters);
    filterRow.querySelector('.filter-value-input').addEventListener('input', updateActiveFilters);

    // Update filters immediately after adding a new filter row
    updateActiveFilters();
});

// Get references to chart type select and dropzones
const chartTypeSelect = document.getElementById('chart-type-select');
const xAxisDropzone = document.getElementById('xaxis-dropzone');
const yAxisDropzone = document.getElementById('yaxis-dropzone');

// Function to toggle dropzone visibility based on chart type
function toggleDropzonesVisibility() {
    const selectedChartType = chartTypeSelect.value;

    // Define which dropzones are needed for each chart type
    const requiredDropzones = {
        'line': ['xaxis', 'yaxis'],
        'bar': ['xaxis', 'yaxis'], // Bar charts can benefit from categories for grouping
        'scatter': ['xaxis', 'yaxis'],
        'pie': ['xaxis', 'yaxis'] // Pie charts need values (yaxis) and labels (xaxis)
        // Add configurations for other chart types here
    };

    // Get the list of dropzones needed for the selected type
    const needed = requiredDropzones[selectedChartType] || [];

    // Hide all dropzones initially
    xAxisDropzone.style.display = 'none';
    yAxisDropzone.style.display = 'none';
    // categoryDropzone was removed

    // Show only the needed dropzones
    if (needed.includes('xaxis')) xAxisDropzone.style.display = 'block';
    if (needed.includes('yaxis')) yAxisDropzone.style.display = 'block';

    // Clear the values of hidden dropzones to prevent sending incorrect data to backend
    if (!needed.includes('xaxis')) xAxisDropzone.dataset.column = '';
    if (!needed.includes('yaxis')) yAxisDropzone.dataset.column = '';
     // Also clear the text content displayed to the user
    if (!needed.includes('xaxis')) xAxisDropzone.querySelector('.card-body').textContent = 'Drop here or click above';
    if (!needed.includes('yaxis')) yAxisDropzone.querySelector('.card-body').textContent = 'Drop here or click above';

}

// Add event listener to chart type select
chartTypeSelect.addEventListener('change', toggleDropzonesVisibility);

// Initial call to set correct dropzones visibility on page load
toggleDropzonesVisibility();

// Update the Run button click handler
document.getElementById('run-button').addEventListener('click', function() {
    const xAxisDropzone = document.getElementById('xaxis-dropzone');
    const yAxisDropzone = document.getElementById('yaxis-dropzone');
    const chartTypeSelect = document.getElementById('chart-type-select');

    const xAxis = xAxisDropzone.dataset.column;
    const yAxis = yAxisDropzone.dataset.column;
    const selectedChartType = chartTypeSelect.value;

    // Determine required dropzones based on the selected chart type
    const requiredDropzones = {
        'line': ['X-axis', 'Y-axis'],
        'bar': ['X-axis', 'Y-axis'], 
        'scatter': ['X-axis', 'Y-axis'],
        'pie': ['X-axis', 'Y-axis'] // Pie chart needs labels (X-axis) and values (Y-axis)
        // Add requirements for other chart types here
    };

    const neededDropzoneNames = requiredDropzones[selectedChartType] || [];
    const missingDropzones = [];

    // Check if required dropzones have columns assigned
    if (neededDropzoneNames.includes('X-axis') && !xAxis) {
        missingDropzones.push('X Axis');
    }
    if (neededDropzoneNames.includes('Y-axis') && !yAxis) {
        missingDropzones.push('Y Axis');
    }

    if (missingDropzones.length > 0) {
        alert(`Please drag and drop a column to the following required settings for a ${selectedChartType} chart: ${missingDropzones.join(', ')}`);
        return;
    }

    // Get the type of the Y-axis column from the availableColumns data
    const yAxisType = availableColumns.find(col => col.name === yAxis)?.type || null;

     // Check if Y-axis is numeric for chart types that require it (line, bar, scatter, pie values)
     // Note: Pie charts technically can use categorical data for counts, but our backend aggregation is numeric.
     // We'll enforce numeric Y-axis for now for consistency with current backend logic.
    if (selectedChartType !== 'categorical-pie' && yAxisType !== 'numeric') { 
        alert(`The Y-axis column for a ${selectedChartType} chart must be numeric.`); 
        console.error(`Y-axis type mismatch for ${selectedChartType} chart: Expected numeric, got ${yAxisType}.`);
        return;
    }

    console.log('Sending visualization data request with:');
    console.log('X-axis:', xAxis);
    console.log('Y-axis:', yAxis);
    console.log('Filters:', activeFilters);
    console.log('Selected Chart Type:', selectedChartType);

    // Get visualization data from backend
    // The backend doesn't need chart type for data preparation, only the frontend does for rendering.
    getVisualizationData(xAxis, yAxis, null, activeFilters)
        .then(data => {
            console.log('Received visualization data:', data);
            // Update visualization area with the data
            const visualizationArea = document.getElementById('visualization-area');
            const canvas = document.getElementById('myChart');

            // Clear previous chart if it exists
            if (window.myChart && typeof window.myChart.destroy === 'function') {
                window.myChart.destroy();
            }

            // Create a new Chart.js chart using the selected chart type
            try {
                // Define a color palette (you can expand this list)
                const colorPalette = [
                    'rgba(255, 99, 132, 0.8)', // Red
                    'rgba(54, 162, 235, 0.8)', // Blue
                    'rgba(255, 206, 86, 0.8)', // Yellow
                    'rgba(75, 192, 192, 0.8)', // Green
                    'rgba(153, 102, 255, 0.8)', // Purple
                    'rgba(255, 159, 64, 0.8)'  // Orange
                ];
                 const borderPalette = [
                    'rgba(255, 99, 132, 1)', // Red
                    'rgba(54, 162, 235, 1)', // Blue
                    'rgba(255, 206, 86, 1)', // Yellow
                    'rgba(75, 192, 192, 1)', // Green
                    'rgba(153, 102, 255, 1)', // Purple
                    'rgba(255, 159, 64, 1)'  // Orange
                ];

                let backgroundColors = [];
                let borderColors = [];

                if (selectedChartType === 'pie') {
                    // Generate colors for each slice based on the data length
                    for (let i = 0; i < data.x.length; i++) {
                        backgroundColors.push(colorPalette[i % colorPalette.length]);
                        borderColors.push(borderPalette[i % borderPalette.length]);
                    }
                } else {
                    // Use single colors for other chart types as before
                     backgroundColors = selectedChartType === 'bar' ? 'rgba(54, 162, 235, 0.5)' : 'rgba(75, 192, 192, 0.5)';
                     borderColors = selectedChartType === 'bar' ? 'rgba(54, 162, 235, 1)' : 'rgba(75, 192, 192, 1)';
                }

                window.myChart = new Chart(canvas, {
                    type: selectedChartType, // Use the selected chart type
                    data: {
                        labels: data.x, // X-axis data will be used for labels
                        datasets: [{
                            label: yAxis, // Y-axis label
                            data: data.y, // Y-axis data will be used for values
                            backgroundColor: backgroundColors, // Use generated colors
                             // For pie chart, we might want a range of colors
                            borderColor: borderColors, // Use generated colors
                            borderWidth: 1,
                            tension: selectedChartType === 'line' ? 0.4 : 0 // Add tension only for line chart
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                display: selectedChartType !== 'pie', // Hide x-axis for pie chart
                                title: {
                                    display: selectedChartType !== 'pie', // Hide x-axis title for pie chart
                                    text: xAxis
                                }
                            },
                            y: {
                                display: selectedChartType !== 'pie', // Hide y-axis for pie chart
                                title: {
                                    display: selectedChartType !== 'pie', // Hide y-axis title for pie chart
                                    text: yAxis
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true, // Always display legend for pie chart
                                position: selectedChartType === 'pie' ? 'right' : 'top', // Position legend to the right for pie chart
                            },
                            title: {
                                display: true,
                                text: `${yAxis} vs ${xAxis}` // Chart title
                            }
                        }
                    }
                });

                 // Remove the placeholder text if it exists
                const placeholder = visualizationArea.querySelector('p');
                if (placeholder && placeholder.textContent === 'Upload data and configure settings to view visualizations or data table.') {
                     placeholder.style.display = 'none';
                }

            } catch (chartError) {
                console.error('Error creating Chart.js chart:', chartError);
                alert('Error rendering chart: ' + chartError.message);
                // Optionally display an error message in the visualization area
                 visualizationArea.innerHTML = `<div class="alert alert-danger">Error rendering chart: ${chartError.message}</div>`;
                 window.myChart = null; // Ensure myChart is null if creation failed
            }

        })
        .catch(error => {
            console.error('Error getting visualization data:', error);
            alert('Error getting visualization data: ' + error.message);
            // Optionally display an error message in the visualization area
             const visualizationArea = document.getElementById('visualization-area');
             visualizationArea.innerHTML = `<div class="alert alert-danger">Error fetching data: ${error.message}</div>`;
             window.myChart = null; // Ensure myChart is null if data fetch failed
        });
});

// Basic Bootstrap form validation (can be removed if not using a form on this page)
(function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            form.classList.add('was-validated')
        }, false)
    })
})()

// Add event listeners for Visualization and Data View buttons
document.querySelectorAll('.btn-outline-secondary').forEach(button => {
    button.addEventListener('click', function() {
        const isVisualizationButton = this.textContent.includes('Visualizations');
        const visualizationArea = document.getElementById('visualization-area');
        const dataViewArea = document.getElementById('data-view-area');
        const noDataViewMessage = document.getElementById('no-data-view-message');
        const dataTable = document.getElementById('data-table');

        // Toggle active button style
        document.querySelectorAll('.btn-outline-secondary').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');

        if (isVisualizationButton) {
            visualizationArea.style.display = 'block';
            dataViewArea.style.display = 'none';
        } else {
            visualizationArea.style.display = 'none';
            dataViewArea.style.display = 'block';

            // Fetch and display data in the table when Data View is selected
            // Use the activeFilters to fetch the filtered data
            applyFilters(activeFilters)
                .then(result => {
                    console.log('Received filtered data for Data View:', result);
                    const previewData = result.preview;
                    const rowCount = result.row_count;

                    const thead = dataTable.querySelector('thead tr');
                    const tbody = dataTable.querySelector('tbody');

                    // Clear previous table content
                    thead.innerHTML = '';
                    tbody.innerHTML = '';
                    noDataViewMessage.style.display = 'none';

                    if (previewData && previewData.length > 0) {
                        // Create table headers from the keys of the first data object
                        const headers = Object.keys(previewData[0]);
                        headers.forEach(header => {
                            const th = document.createElement('th');
                            th.textContent = header;
                            thead.appendChild(th);
                        });

                        // Populate table body with data
                        previewData.forEach(rowData => {
                            const tr = document.createElement('tr');
                            headers.forEach(header => {
                                const td = document.createElement('td');
                                td.textContent = rowData[header];
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });

                        // Optionally display row count (e.g., below the table)
                        // For now, we just populate the table with preview data
                        console.log(`Total rows available: ${rowCount}`);

                    } else {
                        // Display no data message if previewData is empty
                        noDataViewMessage.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching data for Data View:', error);
                    // Optionally display an error message in the data view area
                    noDataViewMessage.style.display = 'block';
                    noDataViewMessage.textContent = `Error loading data: ${error.message}`;
                });
        }
    });
});

// Set Visualizations button as active by default on page load
document.querySelector('.btn-outline-secondary:first-of-type').classList.add('active');
</script>
{% endblock %} 