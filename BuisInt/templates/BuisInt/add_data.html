{% extends 'base.html' %}
{% load static %}

{% block title %}Data Analysis{% endblock %}

{% block main_classes %}
container-fluid h-100 px-0 py-0
{% endblock %}

{% block extra_css %}
{{ block.super }}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- DataTables CSS -->
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/select/1.3.4/css/select.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/searchpanes/2.0.2/css/searchPanes.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/colreorder/1.5.4/css/colReorder.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/fixedheader/3.2.2/css/fixedHeader.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/fixedcolumns/4.0.2/css/fixedColumns.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/keytable/2.6.4/css/keyTable.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/rowgroup/1.1.4/css/rowGroup.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/rowreorder/1.2.8/css/rowReorder.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/scroller/2.0.5/css/scroller.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/searchbuilder/1.3.4/css/searchBuilder.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/stateRestore/1.1.1/css/stateRestore.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<style>
    .main-content-col {
        height: calc(100vh - 56px);
        overflow-y: auto;
    }
    .debug-border {
        border: 1px solid transparent;
    }
    .dropzone {
        min-height: 100px;
        border: 2px dashed #ccc;
        border-radius: 4px;
        padding: 20px;
        text-align: center;
        background: #f8f9fa;
        margin-bottom: 1rem;
    }
    .dropzone.drag-over {
        background-color: #e9ecef;
        border-color: #0d6efd;
    }
    .column-item {
        cursor: move;
    }
    .filter-row {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    #dataTableContainer {
        margin-top: 20px;
    }
    .dataTables_wrapper {
        padding: 20px;
    }
    .column-filter {
        width: 100%;
        margin-top: 5px;
    }
    #dataTable thead th {
        position: relative;
        min-width: 150px;
    }
    .dataTables_scrollBody {
        max-height: 600px !important;
    }
    .chart-container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #myChart {
        width: 100% !important;
        height: 100% !important;
    }
    
    /* Add these styles for the dropdown */
    .dropdown-menu {
        display: none;
    }
    
    .dropdown-menu.show {
        display: block !important;
    }
    
    .dropdown-item {
        white-space: normal;
        padding: 0.5rem 1rem;
    }
    
    .dropdown-item:hover {
        background-color: #f8f9fa;
    }
    
    /* Ensure dropdown is above other elements */
    .dropdown {
        position: relative;
    }
    
    #savedFilesList {
        position: absolute;
        top: 100%;
        right: 0;
        z-index: 1021;
        background-color: white;
        border: 1px solid rgba(0,0,0,.15);
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
    }
    
    /* Add styles for file items */
    .saved-file-item {
        border-bottom: 1px solid #dee2e6;
    }
    
    .saved-file-item:last-child {
        border-bottom: none;
    }

    /* Dropdown styles */
    .dropdown {
        position: relative;
    }

    .dropdown-menu {
        margin-top: 4px;
    }

    .saved-file-item {
        cursor: pointer;
        padding: 8px 16px;
        transition: background-color 0.2s;
    }

    .saved-file-item:hover {
        background-color: #f8f9fa;
    }

    .saved-file-item .delete-btn {
        opacity: 0;
        transition: opacity 0.2s;
    }

    .saved-file-item:hover .delete-btn {
        opacity: 1;
    }

    .saved-file-item .delete-btn:hover {
        color: #dc3545;
    }

    .dropdown-divider {
        margin: 4px 0;
        border-top: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<!-- Add this at the top of the body, after any existing alert containers -->
<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

<!-- Add the Forecasting Modal -->
<div class="modal fade" id="forecastingModal" tabindex="-1" aria-labelledby="forecastingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="forecastingModalLabel">Configure Time Series Forecasting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="forecastingForm">
                    <!-- Data Configuration Section -->
                    <div class="mb-4">
                        <h6 class="mb-3">Data Configuration</h6>
                        
                        <!-- Date Column -->
                        <div class="mb-3">
                            <label for="dateColumn" class="form-label">Date/Time Column</label>
                            <select class="form-select" id="dateColumn" required>
                                <option value="">Select date column</option>
                                <!-- Will be populated dynamically -->
                            </select>
                            <div class="form-text">Select the column containing your time series dates</div>
                        </div>

                        <!-- Target Column -->
                        <div class="mb-3">
                            <label for="targetColumn" class="form-label">Target Column</label>
                            <select class="form-select" id="targetColumn" required>
                                <option value="">Select target column</option>
                                <!-- Will be populated dynamically -->
                            </select>
                            <div class="form-text">Select the column you want to forecast</div>
                        </div>

                        <!-- Product Column -->
                        <div class="mb-3">
                            <label for="productColumn" class="form-label">Product Column</label>
                            <select class="form-select" id="productColumn" required>
                                <option value="">Select product column</option>
                                <!-- Will be populated dynamically -->
                            </select>
                            <div class="form-text">Select the column containing product identifiers</div>
                        </div>

                        <!-- Exogenous Variables -->
                        <div class="mb-3">
                            <label class="form-label">Exogenous Variables</label>
                            <div id="exogenousVariables" class="border rounded p-3">
                                <div class="form-text mb-2">Select additional columns that may affect the forecast</div>
                                <div id="exogenousCheckboxes">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Model Configuration Section -->
                    <div class="mb-4">
                        <h6 class="mb-3">Model Configuration</h6>
                        
                        <!-- Forecasting Method -->
                        <div class="mb-3">
                            <label for="forecastMethod" class="form-label">Forecasting Method</label>
                            <select class="form-select" id="forecastMethod">
                                <option value="lstm">LSTM Neural Network</option>
                                <option value="arima">ARIMA</option>
                                <option value="prophet">Prophet</option>
                            </select>
                        </div>

                        <!-- Forecast Period -->
                        <div class="mb-3">
                            <label for="forecastPeriod" class="form-label">Forecast Period (days)</label>
                            <input type="number" class="form-control" id="forecastPeriod" min="1" max="365" value="30">
                        </div>

                        <!-- Advanced Settings -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showConfidenceInterval">
                                <label class="form-check-label" for="showConfidenceInterval">
                                    Show Confidence Interval
                                </label>
                            </div>
                        </div>

                        <!-- Model Parameters (dynamic based on selected method) -->
                        <div id="modelParameters" class="mb-3">
                            <!-- Parameters will be dynamically loaded based on selected method -->
                        </div>
                    </div>
                </form>

                <!-- Results Preview Area -->
                <div id="forecastResults" class="mt-4" style="display: none;">
                    <h6>Forecast Results</h6>
                    <div class="border rounded p-3">
                        <canvas id="forecastChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <h6>Model Metrics</h6>
                        <div id="modelMetrics" class="row">
                            <!-- Metrics will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="generateForecastBtn">Generate Forecast</button>
            </div>
        </div>
    </div>
</div>

<!-- Add this right after the <div class="row"> -->
<div class="row">
    <div id="alertContainer" class="col-12 mb-3"></div>
    <!-- Rest of your content -->
</div>

<div class="row h-100 no-gutters debug-border" style="height: 100%; margin: 0 !important;"> {# no-gutters to remove column padding #}
    <!-- Left Sidebar: Columns, Chart Settings, and Filters -->
    <div class="col-md-4 col-lg-3 bg-light border-right h-100 overflow-auto main-content-col"> {# Increased left sidebar width, added custom class #}
        <h5 class="mt-3 mb-3 px-3">Sales_Data_New</h5> {# Added horizontal padding #}

        <!-- Data Input/Upload Section -->
        <div class="px-3 py-3 mb-4 border rounded bg-white shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Upload Data</h6>
                <!-- Add dropdown for saved files -->
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" id="saveFileBtn" disabled>
                        <i class="fas fa-save"></i> Save File
                    </button>
                    <div class="dropdown" id="savedFilesContainer">
                        <button class="btn btn-outline-primary" type="button" id="savedFilesDropdown">
                            <i class="fas fa-folder-open"></i> Load Saved File
                            <span class="badge bg-secondary ms-1" id="savedFilesCount">0</span>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end" id="savedFilesList" style="display: none; position: absolute; top: 100%; right: 0; z-index: 9999; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-width: 300px; max-height: 400px; overflow-y: auto;">
                            <div class="dropdown-header bg-light text-dark p-2 border-bottom">Saved Files</div>
                            <div id="savedFilesContent" style="padding: 8px 0;">
                                <!-- Files will be loaded here -->
                                <div class="dropdown-item text-center text-muted py-2">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="file-upload-area" class="form-group text-center p-4 border rounded bg-light cursor-pointer">
                <div class="input-group" style="width: auto; display: inline-flex;">
                    <input type="file" class="form-control d-none" id="data-upload-input" accept=".csv">
                    <label class="btn btn-outline-primary" for="data-upload-input">Choose CSV File</label>
                    <span class="ms-2 text-muted">or drag and drop file here</span>
                </div>
                <small class="form-text text-muted mt-2 d-block">Supported format: CSV</small>
            </div>
        </div>

        <!-- After the upload section and before the data table -->
        

        <div class="row no-gutters px-3 mb-3"> {# Row for horizontal layout within sidebar, added bottom margin #}
            <!-- Data Columns List -->
            <div class="col-6 pe-2"> {# Takes half width, added right padding #}
                <h6>Columns</h6>
                <ul id="columns-list" class="list-group list-group-flush border rounded bg-white shadow-sm p-2"> {# Added border, rounded, background, shadow, padding #}
                    {# This list should be populated dynamically by JavaScript after data upload #}
                </ul>
                 {# Add a message when no columns are loaded #}
                 <p id="no-columns-message" class="text-muted mt-2 px-2 text-center">Upload data to see columns.</p>
            </div>

            <!-- Chart Settings / Column Mapping -->
            <div class="col-6 ps-2"> {# Takes other half width, added left padding #}
                <h6>Chart Settings</h6>
                
                {# Chart Type Selection #}
                <div class="mb-2">
                    <label for="chart-type-select" class="form-label form-label-sm">Chart Type</label>
                    <select class="form-select form-select-sm" id="chart-type-select">
                        <option value="line">Line Chart</option>
                        <option value="bar" selected>Bar Chart</option>
                        <option value="scatter">Scatter Plot</option>
                        <option value="pie">Pie Chart</option>
                         {# Add more chart types as needed #}
                    </select>
                </div>

                

                <div id="xaxis-dropzone" class="card mb-2 border rounded bg-white shadow-sm dropzone"> {# Added border, rounded, background, shadow #}
                    <div class="card-header">X Axis</div>
                    <div class="card-body p-2 text-muted text-center">
                        Drop here or click above
                        {# Area where dragged column names would appear #}
                    </div>
                </div>
                 <div id="yaxis-dropzone" class="card mb-2 border rounded bg-white shadow-sm dropzone"> {# Added border, rounded, background, shadow #}
                    <div class="card-header">Y Axis</div>
                    <div class="card-body p-2 text-muted text-center">
                        Drop here or click above
                        {# Area where dragged column names would appear #}
                    </div>
                </div>
                {# Add more settings like Break-Out, Row Limit, Sort, etc. as needed #}
            </div>
        </div> {# End row for horizontal layout #}

        
        <div class="card mb-2 border rounded bg-white shadow-sm">
            <div class="px-4">
                <div class="form-check card-body p-2 text-muted">
                    {# Group by X-axis Checkbox #}
                    <input class="form-check-input" type="checkbox" value="" id="group-by-xaxis-checkbox" >
                    <label class="form-check-label" for="group-by-xaxis-checkbox">
                        Group by X-axis
                    </label>
                </div>
                <div class="card-body p-2" id="aggregation-options" style="display: none;">
                    <label class="form-label mb-1">Aggregation Method:</label>
                    <select class="form-select form-select-sm" id="aggregation-method">
                        <option value="avg">Average</option>
                        <option value="sum">Sum</option>
                        <option value="count">Count</option>
                        <option value="min">Minimum</option>
                        <option value="max">Maximum</option>
                    </select>
                </div>
            </div>   
        </div>

        <!-- Filters Section official -->
         <div class="mb-4 px-3"> {# Added horizontal padding #}
            <h6>Filters</h6>
             <div id="filters-area" class="card mb-2 border rounded bg-white shadow-sm"> {# Added ID, border, rounded, background, shadow #}
                <div class="card-body p-2 text-muted">
                    <p class="text-center add-filter-btn">+ Add Filter</p> {# Made text clickable #}
                    {# Area for dynamically added filters #}
                    <div id="dynamic-filters-container"></div> {# Container for filters #}
                </div>
            </div>
         </div>

         {# Placeholder for other potential controls related to uploaded data #}

    </div>

    <!-- Right Content: Visualizations and Data View -->
    <div class="col-md-8 col-lg-9 h-100 d-flex flex-column main-content-col"> {# Adjusted width and added flex for content, added custom class #}
        <div class="d-flex justify-content-between align-items-center py-3 px-3 border-bottom"> {# Added padding and border #}
            <div>
                <button class="btn btn-outline-secondary me-2"><i class="fas fa-chart-bar"></i> Visualizations</button>
                <button class="btn btn-outline-secondary"><i class="fas fa-table"></i> Data View</button>
                 {# Buttons for Build, Format tabs #}
            </div>
            <div>
                {# Actions like Download, Run #}
                <!-- <button id="run-button" class="btn btn-primary me-2"><i class="fas fa-play"></i> Run</button> -->
                <button id="forecasting-button" class="btn btn-success me-2"><i class="fas fa-chart-line"></i> Forecasting</button>
                <!-- <button class="btn btn-secondary me-2"><i class="fas fa-download"></i> Download</button> -->
                <!-- <button id="saveFileBtn" class="btn btn-success me-2"><i class="fas fa-save"></i> Save</button> -->
                {# More action buttons like View, Add to Dashboard #}
            </div>
        </div>

        <!-- Visualization/Data Area -->
        <div class="flex-grow-1 overflow-auto p-3">
            <div id="visualization-area" class="chart-container" style="position: relative; height:60vh; width:100%;">
                <canvas id="myChart"></canvas>
            </div>

            <!-- Data View Area -->
            <div id="data-view-area" class="mt-3" style="display: none;">
                <div class="table-responsive">
                    <table id="data-table" class="table table-striped table-bordered table-hover">
                        <thead>
                            <tr>
                                <!-- Table headers will be added by JavaScript -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table rows will be added by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <p id="no-data-view-message" class="text-muted text-center" style="display: none;">
                    No data available to display.
                </p>
            </div>
        </div>

         <!-- Show Query / Jobs Area (Optional) -->
        <div class="border-top mt-auto p-2"> {# mt-auto to push to bottom #}
             <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="query-tab" data-bs-toggle="tab" data-bs-target="#query" type="button" role="tab" aria-controls="query" aria-selected="true">Show Query</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs" type="button" role="tab" aria-controls="jobs" aria-selected="false">Jobs</button>
                </li>
             </ul>
             <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="query" role="tabpanel" aria-labelledby="query-tab">
                    {# Display generated query here #}
                     <p class="mt-2 text-muted">Query will appear here after running.</p>
                </div>
                <div class="tab-pane fade" id="jobs" role="tabpanel" aria-labelledby="jobs-tab">
                     {# Display job status here #}
                     <p class="mt-2 text-muted">Job status will appear here.</p>
                </div>
             </div>
        </div>

    </div>
</div>

<!-- Add this modal for saving files -->
<div class="modal fade" id="saveFileModal" tabindex="-1" aria-labelledby="saveFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveFileModalLabel">Save File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saveFileForm">
                    <div class="mb-3">
                        <label for="filename" class="form-label">Filename</label>
                        <input type="text" class="form-control" id="filename" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description (optional)</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Add this modal for loading saved files -->
<div class="modal fade" id="loadFileModal" tabindex="-1" aria-labelledby="loadFileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loadFileModalLabel">Load Saved File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group" id="savedFilesList">
                    <!-- Saved files will be listed here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast container -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    <!-- Toasts will be dynamically added here -->
</div>

<!-- Add this button to the top controls -->
<button id="loadFileBtn" class="btn btn-info me-2"><i class="fas fa-folder-open"></i> Load Saved File</button>

<!-- Add this after your existing content -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Data Preview</h5>
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary me-2" id="rowCount">0 rows</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="dataTableContainer">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Columns</h5>
            </div>
            <div class="card-body">
                <div id="columnsContainer">
                    <!-- Column badges will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Column Statistics</h5>
            </div>
            <div class="card-body">
                <div id="columnStatsContainer">
                    <!-- Column statistics will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Filters</h5>
            </div>
            <div class="card-body">
                <div id="filtersContainer" class="row">
                    <!-- Filter inputs will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<!-- DataTables Buttons -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>

<!-- DataTables Responsive -->
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>

<!-- Custom JavaScript -->
<script>
// Initialize chart variable
let myChart = null;

// Function to show toast notifications
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '1050';
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.id = toastId;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    // Create toast content
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;

    // Add toast to container
    toastContainer.appendChild(toast);

    // Initialize and show toast
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
    });
    bsToast.show();

    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
}

// Replace the old showAlert function
function showAlert(message, type) {
    showToast(message, type);
}

// Function to update chart
function updateChart(data, chartType) {
    const ctx = document.getElementById('myChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (myChart instanceof Chart) {
        myChart.destroy();
    }
    
    // Log the data being used to create the chart
    console.log('Creating chart with data:', data);
    
    // Configure chart data
    const chartConfig = {
        type: chartType,
        data: {
            labels: data.labels,
            datasets: [{
                label: data.y_axis_label,
                data: data.values,
                backgroundColor: chartType === 'scatter' ? 'rgba(54, 162, 235, 1)' :
                    chartType === 'line' ? 'rgba(54, 162, 235, 0.2)' : 
                    Array(data.values.length).fill('rgba(54, 162, 235, 0.2)'),
                borderColor: chartType === 'scatter' ? 'rgba(54, 162, 235, 1)' :
                    chartType === 'line' ? 'rgba(54, 162, 235, 1)' : 
                    Array(data.values.length).fill('rgba(54, 162, 235, 1)'),
                borderWidth: chartType === 'scatter' ? 1 : 1,
                pointRadius: chartType === 'scatter' ? 3 : 3,
                pointHoverRadius: chartType === 'scatter' ? 5 : 4,
                fill: chartType === 'scatter' ? false : true,
                tension: chartType === 'line' ? 0.4 : 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: data.y_axis_label
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: data.x_axis_label
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                title: {
                    display: true,
                    text: `${data.y_axis_label} vs ${data.x_axis_label}`
                },
                tooltip: {
                    enabled: true,
                    mode: chartType === 'scatter' ? 'nearest' : 'index',
                    intersect: chartType === 'scatter',
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toLocaleString();
                            }
                            return label;
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    };
    
    // Create new chart
    try {
        console.log('Chart configuration:', chartConfig);
        myChart = new Chart(ctx, chartConfig);
    } catch (error) {
        console.error('Error creating chart:', error);
        showToast('Error creating chart: ' + error.message, 'danger');
    }
}

// ... rest of your existing JavaScript code ...

// Add view switching functionality
document.querySelectorAll('.btn-outline-secondary').forEach(button => {
    button.addEventListener('click', function() {
        // Remove active class from all buttons
        document.querySelectorAll('.btn-outline-secondary').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Add active class to clicked button
        this.classList.add('active');
        
        // Get the view type from button text
        const viewType = this.textContent.trim().toLowerCase();
        
        // Show/hide appropriate view
        const visualizationArea = document.getElementById('visualization-area');
        const dataViewArea = document.getElementById('data-view-area');
        
        if (viewType.includes('visualization')) {
            visualizationArea.style.display = 'block';
            dataViewArea.style.display = 'none';
            
            // Refresh chart if exists
            if (window.myChart) {
                window.myChart.update();
            }
        } else if (viewType.includes('data')) {
            visualizationArea.style.display = 'none';
            dataViewArea.style.display = 'block';
            
            // Adjust DataTable columns if exists
            if ($.fn.DataTable.isDataTable('#dataTable')) {
                $('#dataTable').DataTable().columns.adjust().draw();
            }
        }
    });
});

// Initialize file upload functionality
document.addEventListener('DOMContentLoaded', function() {
    const fileUploadArea = document.getElementById('file-upload-area');
    const fileInput = document.getElementById('data-upload-input');
    const columnsList = document.getElementById('columns-list');
    const noColumnsMessage = document.getElementById('no-columns-message');

    // File input change handler
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            handleFileUpload(file);
        }
    });

    // Drag and drop handlers
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.add('border-primary');
    });

    fileUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('border-primary');
    });

    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('border-primary');

        const file = e.dataTransfer.files[0];
        if (file) {
            handleFileUpload(file);
        }
    });

    // File upload handler
    function handleFileUpload(file) {
        console.log('Processing file:', file.name);
        
        // Show loading alert
        const loadingAlert = showAlert('Processing file...', 'info');
        
        const formData = new FormData();
        formData.append('file', file);
        
        // Get CSRF token
        const csrftoken = getCookie('csrftoken');
        
        fetch('/business/api/upload-data/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            console.log('Response data:', result);
            
            if (result.status === 'success' && result.data) {
                // Remove loading alert
                if (loadingAlert) {
                    loadingAlert.remove();
                }
                
                const data = result.data;
                
                // Validate required data
                if (!data.columns || !data.data || !data.column_types) {
                    throw new Error('Invalid data format received from server');
                }
                
                // Update the data table
                updateDataTable(data);
                
                // Update column types
                window.columnTypes = data.column_types || {};
                
                // Update available columns
                window.availableColumns = (data.columns || []).map(col => ({
                    name: col,
                    type: (data.column_types || {})[col] || 'unknown'
                }));
                
                console.log('Columns loaded:', window.availableColumns);
                
                // Update columns list
                updateColumnsList();
                
                // Update UI components
                updateColumnDisplay();
                populateColumnSelectors();
                
                if (data.column_stats) {
                    updateColumnStats(data.column_stats);
                }
                
                // Enable buttons
                const forecastingBtn = document.getElementById('forecasting-button');
                const downloadBtn = document.getElementById('download-button');
                const saveBtn = document.getElementById('saveFileBtn');
                
                if (forecastingBtn) forecastingBtn.disabled = false;
                if (downloadBtn) downloadBtn.disabled = false;
                if (saveBtn) saveBtn.disabled = false;
                
                // Show success message
                showToast(`File "${file.name}" loaded successfully with ${window.availableColumns.length} columns!`, 'success');
            } else {
                throw new Error(result.message || 'Failed to load file data');
            }
        })
        .catch(error => {
            console.error('Error processing file:', error);
            if (loadingAlert) {
                loadingAlert.remove();
            }
            showToast('Error processing file: ' + error.message, 'danger');
        });
    }

    // Function to update columns list
    function updateColumnsList() {
        if (!columnsList) return;
        
        columnsList.innerHTML = '';
        
        if (!window.availableColumns || window.availableColumns.length === 0) {
            if (noColumnsMessage) {
                noColumnsMessage.style.display = 'block';
            }
            return;
        }

        if (noColumnsMessage) {
            noColumnsMessage.style.display = 'none';
        }

        window.availableColumns.forEach(column => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center column-item';
            li.setAttribute('draggable', true);
            li.dataset.column = column.name;
            li.dataset.type = column.type;
            
            li.innerHTML = `
                ${column.name}
                <span class="badge bg-${getColumnTypeColor(column.type)}">${column.type}</span>
            `;
            
            // Add drag functionality
            li.addEventListener('dragstart', handleDragStart);
            li.addEventListener('dragend', handleDragEnd);
            
            columnsList.appendChild(li);
        });
    }

    // Helper function to get column type color
    function getColumnTypeColor(type) {
        switch(type.toLowerCase()) {
            case 'numeric':
                return 'primary';
            case 'datetime':
                return 'success';
            case 'categorical':
                return 'warning';
            default:
                return 'secondary';
        }
    }
});

// Add drag and drop functionality
function handleDragStart(e) {
    console.log('Dragging:', this.dataset.column);
    e.dataTransfer.setData('text/plain', this.dataset.column);
    this.classList.add('dragging');
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
}

// Initialize dropzone functionality
document.addEventListener('DOMContentLoaded', function() {
    const dropzones = document.querySelectorAll('.dropzone');
    
    dropzones.forEach(dropzone => {
        dropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('drag-over');
        });

        dropzone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
        });

        dropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
            
            const columnName = e.dataTransfer.getData('text/plain');
            console.log('Dropped:', columnName, 'on', this.id);
            
            // Update dropzone content
            const cardBody = this.querySelector('.card-body');
            if (cardBody) {
                cardBody.textContent = columnName;
                this.dataset.column = columnName;
                
                // Trigger visualization update if both axes are set
                const xAxis = document.getElementById('xaxis-dropzone').dataset.column;
                const yAxis = document.getElementById('yaxis-dropzone').dataset.column;
                
                if (xAxis && yAxis) {
                    updateVisualization();
                }
            }
        });
    });
});

// Function to update visualization
function updateVisualization() {
    const xAxis = document.getElementById('xaxis-dropzone').dataset.column;
    const yAxis = document.getElementById('yaxis-dropzone').dataset.column;
    const chartType = document.getElementById('chart-type-select').value;
    const groupByXAxis = document.getElementById('group-by-xaxis-checkbox').checked;
    const aggregationMethod = document.getElementById('aggregation-method')?.value || 'avg';
    
    if (!xAxis || !yAxis) {
        console.log('Missing axis data');
        return;
    }
    
    // Get active filters
    const filters = Array.from(document.querySelectorAll('.filter-row')).map(row => {
        const column = row.querySelector('.filter-column-select').value;
        const operator = row.querySelector('.filter-operator-select').value;
        const valueContainer = row.querySelector('.filter-value-container');
        
        let value;
        if (operator === 'between') {
            const inputs = valueContainer.querySelectorAll('input');
            value = {
                min: inputs[0].value,
                max: inputs[1].value
            };
        } else if (operator === 'in') {
            value = valueContainer.querySelector('input').value.split(',').map(v => v.trim());
        } else {
            const input = valueContainer.querySelector('input');
            value = input.type === 'number' ? parseFloat(input.value) : input.value;
        }
        
        return { column, operator, value };
    }).filter(filter => filter.column && filter.operator && 
        (filter.value !== '' && filter.value !== null && filter.value !== undefined));
    
    // Log the current state
    console.log('Current visualization state:');
    console.log('X-axis:', xAxis);
    console.log('Y-axis:', yAxis);
    console.log('Chart type:', chartType);
    console.log('Group by X-axis:', groupByXAxis);
    console.log('Aggregation method:', aggregationMethod);
    console.log('Active filters:', filters);
    
    // Show loading state
    const visualizationArea = document.getElementById('visualization-area');
    if (visualizationArea) {
        visualizationArea.style.opacity = '0.5';
    }
    
    // Make API request to get visualization data
    fetch('/business/api/visualization-data/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            x_axis: xAxis,
            y_axis: yAxis,
            group_by_x_axis: groupByXAxis,
            aggregation_method: aggregationMethod,
            filters: filters,
            chart_type: chartType
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to get visualization data');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Received visualization data:', data);
        if (visualizationArea) {
            visualizationArea.style.opacity = '1';
        }
        
        if (data.status === 'success' && data.data) {
            // Log the data structure
            console.log('Chart data structure:', data.data);
            
            // Format data for chart
            const chartData = {
                labels: data.data.x || [],
                values: data.data.y || [],
                x_axis_label: xAxis + (groupByXAxis ? ' (Grouped)' : ''),
                y_axis_label: yAxis + (groupByXAxis ? ` (${aggregationMethod.toUpperCase()})` : '')
            };
            
            // Log the formatted data
            console.log('Formatted chart data:', chartData);
            
            // Update the chart
            updateChart(chartData, chartType);
        } else {
            throw new Error(data.message || 'Invalid data structure received');
        }
    })
    .catch(error => {
        console.error('Error getting visualization data:', error);
        if (visualizationArea) {
            visualizationArea.style.opacity = '1';
        }
        showToast(error.message, 'danger');
    });
}

// Function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Function to update column display in dropzones
function updateColumnDisplay() {
    const dropzones = document.querySelectorAll('.dropzone');
    dropzones.forEach(dropzone => {
        const column = dropzone.dataset.column;
        const cardBody = dropzone.querySelector('.card-body');
        if (cardBody && column) {
            cardBody.textContent = column;
        }
    });
}

// Function to populate column selectors in the forecasting modal
function populateColumnSelectors() {
    const selectors = [
        'dateColumn',
        'targetColumn',
        'productColumn'
    ];
    
    selectors.forEach(selectorId => {
        const select = document.getElementById(selectorId);
        if (!select) return;
        
        // Clear existing options
        select.innerHTML = '<option value="">Select column</option>';
        
        // Add new options
        if (window.availableColumns) {
            window.availableColumns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.name;
                option.textContent = column.name;
                select.appendChild(option);
            });
        }
    });
    
    // Populate exogenous variables checkboxes
    const exogenousContainer = document.getElementById('exogenousCheckboxes');
    if (exogenousContainer && window.availableColumns) {
        exogenousContainer.innerHTML = '';
        window.availableColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
                <input class="form-check-input" type="checkbox" value="${column.name}" id="exog_${column.name}">
                <label class="form-check-label" for="exog_${column.name}">
                    ${column.name}
                </label>
            `;
            exogenousContainer.appendChild(div);
        });
    }
}

// Function to update column statistics
function updateColumnStats(stats) {
    // Implementation depends on your stats display UI
    console.log('Column stats updated:', stats);
}

// Function to update data table
function updateDataTable(data) {
    const table = document.getElementById('data-table');
    if (!table) return;
    
    // Clear existing table
    table.innerHTML = '';
    
    // Create header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    data.columns.forEach(column => {
        const th = document.createElement('th');
        th.textContent = column;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create body
    const tbody = document.createElement('tbody');
    data.data.forEach(row => {
        const tr = document.createElement('tr');
        data.columns.forEach(column => {
            const td = document.createElement('td');
            td.textContent = row[column] || '';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    
    // Initialize DataTable
    if ($.fn.DataTable.isDataTable(table)) {
        $(table).DataTable().destroy();
    }
    
    $(table).DataTable({
        pageLength: 10,
        scrollX: true,
        scrollY: '400px',
        scrollCollapse: true,
        dom: 'Bfrtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ]
    });
}

// Add filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const filtersArea = document.getElementById('filters-area');
    const addFilterBtn = document.querySelector('.add-filter-btn');
    const dynamicFiltersContainer = document.getElementById('dynamic-filters-container');

    // Function to create filter row
    function createFilterRow() {
        const filterRow = document.createElement('div');
        filterRow.className = 'filter-row p-2 mb-2 border rounded';

        // Create filter content with Bootstrap styling
        filterRow.innerHTML = `
            <div class="d-flex align-items-center gap-2">
                <select class="form-select form-select-sm filter-column-select" style="width: 30%;">
                    <option value="">Select Column</option>
                    ${window.availableColumns ? window.availableColumns.map(col => 
                        `<option value="${col.name}">${col.name}</option>`).join('') : ''}
                </select>
                
                <select class="form-select form-select-sm filter-operator-select" style="width: 20%;">
                    <option value="==">Equals</option>
                    <option value="!=">Not Equals</option>
                    <option value="contains">Contains</option>
                    <option value=">">Greater Than</option>
                    <option value="<">Less Than</option>
                    <option value=">=">Greater Than or Equal</option>
                    <option value="<=">Less Than or Equal</option>
                    <option value="between">Between</option>
                    <option value="in">In List</option>
                    <option value="starts_with">Starts With</option>
                    <option value="ends_with">Ends With</option>
                </select>
                
                <div class="filter-value-container" style="width: 40%;">
                    <input type="text" class="form-control form-control-sm filter-value-input" 
                           placeholder="Enter value">
                </div>
                
                <button type="button" class="btn btn-danger btn-sm remove-filter">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        // Add event listeners for the new filter row
        const columnSelect = filterRow.querySelector('.filter-column-select');
        const operatorSelect = filterRow.querySelector('.filter-operator-select');
        const valueContainer = filterRow.querySelector('.filter-value-container');
        const removeBtn = filterRow.querySelector('.remove-filter');

        // Column select change handler
        columnSelect.addEventListener('change', function() {
            const selectedColumn = this.value;
            const columnType = window.availableColumns.find(col => col.name === selectedColumn)?.type;
            
            // Update available operators based on column type
            updateOperatorOptions(operatorSelect, columnType);
            
            // Update value input
            updateValueInput(columnType, operatorSelect.value, valueContainer);
        });

        // Operator select change handler
        operatorSelect.addEventListener('change', function() {
            const selectedColumn = columnSelect.value;
            const columnType = window.availableColumns.find(col => col.name === selectedColumn)?.type;
            updateValueInput(columnType, this.value, valueContainer);
        });

        // Remove button handler
        removeBtn.addEventListener('click', function() {
            filterRow.remove();
            updateVisualization(); // Update visualization when filter is removed
        });

        // Add change event listeners to trigger visualization update
        filterRow.querySelectorAll('select, input').forEach(element => {
            element.addEventListener('change', () => {
                updateVisualization();
            });
            
            // For text inputs, add input event listener with debounce
            if (element.tagName === 'INPUT') {
                element.addEventListener('input', debounce(() => {
                    updateVisualization();
                }, 500));
            }
        });

        return filterRow;
    }

    // Function to update operator options based on column type
    function updateOperatorOptions(operatorSelect, columnType) {
        const numericOperators = [
            { value: '==', text: 'Equals' },
            { value: '!=', text: 'Not Equals' },
            { value: '>', text: 'Greater Than' },
            { value: '<', text: 'Less Than' },
            { value: '>=', text: 'Greater Than or Equal' },
            { value: '<=', text: 'Less Than or Equal' },
            { value: 'between', text: 'Between' },
            { value: 'in', text: 'In List' }
        ];

        const stringOperators = [
            { value: '==', text: 'Equals' },
            { value: '!=', text: 'Not Equals' },
            { value: 'contains', text: 'Contains' },
            { value: 'starts_with', text: 'Starts With' },
            { value: 'ends_with', text: 'Ends With' },
            { value: 'in', text: 'In List' }
        ];

        const datetimeOperators = [
            { value: '==', text: 'Equals' },
            { value: '!=', text: 'Not Equals' },
            { value: '>', text: 'After' },
            { value: '<', text: 'Before' },
            { value: '>=', text: 'On or After' },
            { value: '<=', text: 'On or Before' },
            { value: 'between', text: 'Between' }
        ];

        let operators;
        switch(columnType) {
            case 'numeric':
                operators = numericOperators;
                break;
            case 'datetime':
                operators = datetimeOperators;
                break;
            default:
                operators = stringOperators;
        }

        operatorSelect.innerHTML = operators.map(op => 
            `<option value="${op.value}">${op.text}</option>`
        ).join('');
    }

    // Function to update value input based on column type and operator
    function updateValueInput(columnType, operator, container) {
        let inputHTML = '';
        
        switch(operator) {
            case 'between':
                const inputType = columnType === 'datetime' ? 'datetime-local' : 
                                columnType === 'numeric' ? 'number' : 'text';
                inputHTML = `
                    <div class="input-group input-group-sm">
                        <input type="${inputType}" class="form-control filter-value-input" placeholder="Min">
                        <span class="input-group-text">to</span>
                        <input type="${inputType}" class="form-control filter-value-input" placeholder="Max">
                    </div>
                `;
                break;
            case 'in':
                inputHTML = `
                    <input type="text" class="form-control form-control-sm filter-value-input" 
                           placeholder="Comma-separated values">
                `;
                break;
            default:
                let type = 'text';
                if (columnType === 'numeric') {
                    type = 'number';
                    inputHTML = `
                        <input type="${type}" class="form-control form-control-sm filter-value-input" 
                               placeholder="Enter value" step="any">
                    `;
                } else if (columnType === 'datetime') {
                    type = 'datetime-local';
                    inputHTML = `
                        <input type="${type}" class="form-control form-control-sm filter-value-input" 
                               placeholder="Enter date/time">
                    `;
                } else {
                    inputHTML = `
                        <input type="${type}" class="form-control form-control-sm filter-value-input" 
                               placeholder="Enter value">
                    `;
                }
        }
        
        container.innerHTML = inputHTML;
        
        // Add event listeners to new inputs
        container.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', updateVisualization);
            input.addEventListener('input', debounce(updateVisualization, 500));
        });
    }

    // Add filter button click handler
    if (addFilterBtn) {
        addFilterBtn.addEventListener('click', function() {
            const filterRow = createFilterRow();
            dynamicFiltersContainer.appendChild(filterRow);
        });
    }
});

// Debounce function to limit how often a function is called
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Initialize chart type selector
document.addEventListener('DOMContentLoaded', function() {
    const chartTypeSelect = document.getElementById('chart-type-select');
    if (chartTypeSelect) {
        // Add event listener for chart type change
        chartTypeSelect.addEventListener('change', function() {
            updateVisualization();
        });
    }

    // Add event listener for group by checkbox
    const groupByCheckbox = document.getElementById('group-by-xaxis-checkbox');
    if (groupByCheckbox) {
        groupByCheckbox.addEventListener('change', function() {
            updateVisualization();
        });
    }
});

// Add this to your existing DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    const groupByCheckbox = document.getElementById('group-by-xaxis-checkbox');
    const aggregationOptions = document.getElementById('aggregation-options');
    const aggregationMethod = document.getElementById('aggregation-method');

    if (groupByCheckbox) {
        groupByCheckbox.addEventListener('change', function() {
            if (aggregationOptions) {
                aggregationOptions.style.display = this.checked ? 'block' : 'none';
            }
            updateVisualization();
        });
    }

    if (aggregationMethod) {
        aggregationMethod.addEventListener('change', function() {
            updateVisualization();
        });
    }
});

// Add event listeners for all interactive elements
document.addEventListener('DOMContentLoaded', function() {
    // Existing event listeners...
    
    // Add event listeners for filter changes
    document.addEventListener('change', function(event) {
        const filterRow = event.target.closest('.filter-row');
        if (filterRow && 
            (event.target.matches('.filter-column-select') || 
             event.target.matches('.filter-operator-select') || 
             event.target.matches('.filter-value-container input'))) {
            console.log('Filter changed, updating visualization');
            updateVisualization();
        }
    });
    
    // Add event listener for filter input
    document.addEventListener('input', function(event) {
        const filterRow = event.target.closest('.filter-row');
        if (filterRow && event.target.matches('.filter-value-container input')) {
            // Debounce the update
            clearTimeout(event.target.dataset.timeout);
            event.target.dataset.timeout = setTimeout(() => {
                console.log('Filter input changed, updating visualization');
                updateVisualization();
            }, 500);
        }
    });
    
    // Add event listeners for grouping changes
    const groupByCheckbox = document.getElementById('group-by-xaxis-checkbox');
    const aggregationMethod = document.getElementById('aggregation-method');
    
    if (groupByCheckbox) {
        groupByCheckbox.addEventListener('change', function() {
            console.log('Group by changed, updating visualization');
            const aggregationOptions = document.getElementById('aggregation-options');
            if (aggregationOptions) {
                aggregationOptions.style.display = this.checked ? 'block' : 'none';
            }
            updateVisualization();
        });
    }
    
    if (aggregationMethod) {
        aggregationMethod.addEventListener('change', function() {
            console.log('Aggregation method changed, updating visualization');
            updateVisualization();
        });
    }
});

// Initialize save functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Running debug checks');
    debugDropdownElements();

    const saveFileBtn = document.getElementById('saveFileBtn');
    const confirmSaveBtn = document.getElementById('confirmSaveBtn');
    const saveFileForm = document.getElementById('saveFileForm');
    const savedFilesList = document.getElementById('savedFilesList');
    const savedFilesContent = document.getElementById('savedFilesContent');
    const savedFilesCount = document.getElementById('savedFilesCount');
    const savedFilesDropdown = document.getElementById('savedFilesDropdown');
    
    // Add click handler for save button
    if (saveFileBtn) {
        saveFileBtn.addEventListener('click', function() {
            // Show the save modal
            const saveModal = new bootstrap.Modal(document.getElementById('saveFileModal'));
            saveModal.show();
        });
    }

    // Add click handler for confirm save button
    if (confirmSaveBtn) {
        confirmSaveBtn.addEventListener('click', async function() {
            const filenameInput = document.getElementById('filename');
            const descriptionInput = document.getElementById('description');

            if (!filenameInput.value) {
                showToast('Please enter a filename', 'warning');
                return;
            }

            try {
                const response = await fetch('/business/api/save-file/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        filename: filenameInput.value,
                        description: descriptionInput.value
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // Close the modal
                    const saveModal = bootstrap.Modal.getInstance(document.getElementById('saveFileModal'));
                    saveModal.hide();

                    // Clear the form
                    saveFileForm.reset();

                    // Update the saved files list
                    updateSavedFilesList();

                    // Show success message
                    showToast('File saved successfully!', 'success');
                } else {
                    throw new Error(result.message || 'Failed to save file');
                }
            } catch (error) {
                console.error('Error saving file:', error);
                showToast('Error saving file: ' + error.message, 'danger');
            }
        });
    }

    // Add click handler for the dropdown button
    if (savedFilesDropdown) {
        savedFilesDropdown.addEventListener('click', function(event) {
            event.stopPropagation();
            const isVisible = savedFilesList.style.display === 'block';
            toggleDropdown(!isVisible);
            if (!isVisible) {
                updateSavedFilesList();
            }
        });
    }

    // Initial load of saved files count
    updateSavedFilesList();
});

// Function to toggle dropdown visibility
function toggleDropdown(show) {
    const dropdownMenu = document.getElementById('savedFilesList');
    if (!dropdownMenu) return;
    
    if (show) {
        dropdownMenu.style.display = 'block';
        // Position the dropdown relative to the button
        const button = document.getElementById('savedFilesDropdown');
        if (button) {
            const buttonRect = button.getBoundingClientRect();
            dropdownMenu.style.top = (buttonRect.bottom + 4) + 'px';
            dropdownMenu.style.right = '0';
        }
    } else {
        dropdownMenu.style.display = 'none';
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const container = document.getElementById('savedFilesContainer');
    const dropdownMenu = document.getElementById('savedFilesList');
    
    if (!container || !dropdownMenu) return;
    
    if (!container.contains(event.target)) {
        toggleDropdown(false);
    }
});

// Function to handle loading a saved file
async function handleLoadFile(fileId, filename) {
    console.log(`Loading file: ${filename} (ID: ${fileId})`);
    try {
        showToast(`Loading file "${filename}"...`, 'info');

        const response = await fetch('/business/api/load-saved-file/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                file_id: fileId
            })
        });

        const result = await response.json();
        console.log('Load file API response:', result);

        if (result.status === 'success' && result.data) {
            const data = result.data;

            // Validate required data
            if (!data.columns || !data.data || !data.column_types) {
                throw new Error('Invalid data format received from server');
            }

            console.log('Updating UI with loaded file data');
            // Update the data table
            updateDataTable(data);

            // Update column types
            window.columnTypes = data.column_types || {};

            // Update available columns
            window.availableColumns = (data.columns || []).map(col => ({
                name: col,
                type: (data.column_types || {})[col] || 'unknown'
            }));

            // Update columns list
            updateColumnsList();

            // Update UI components
            updateColumnDisplay();
            populateColumnSelectors();

            if (data.column_stats) {
                updateColumnStats(data.column_stats);
            }

            // Enable buttons
            const forecastingBtn = document.getElementById('forecasting-button');
            const downloadBtn = document.getElementById('download-button');
            const saveBtn = document.getElementById('saveFileBtn');
            
            if (forecastingBtn) forecastingBtn.disabled = false;
            if (downloadBtn) downloadBtn.disabled = false;
            if (saveBtn) saveBtn.disabled = false;

            showToast(`File "${filename}" loaded successfully!`, 'success');
        } else {
            throw new Error(result.message || 'Failed to load file data');
        }
    } catch (error) {
        console.error('Error loading file:', error);
        showToast('Error loading file: ' + error.message, 'danger');
    }
}

// Debug function to check dropdown elements
function debugDropdownElements() {
    console.log('Debugging dropdown elements:');
    console.log('Container:', document.getElementById('savedFilesContainer'));
    console.log('Button:', document.getElementById('savedFilesDropdown'));
    console.log('Menu:', document.getElementById('savedFilesList'));
    console.log('Content:', document.getElementById('savedFilesContent'));
}

// Function to handle file deletion
async function handleDeleteFile(event, fileId, filename) {
    event.stopPropagation(); // Prevent the click from bubbling to the parent
    
    if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
        return;
    }
    
    try {
        const response = await fetch('/business/api/delete-saved-file/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                file_id: fileId
            })
        });

        const result = await response.json();
        
        if (result.status === 'success') {
            showToast(`File "${filename}" deleted successfully`, 'success');
            // Update the saved files list
            await updateSavedFilesList();
        } else {
            throw new Error(result.message || 'Failed to delete file');
        }
    } catch (error) {
        console.error('Error deleting file:', error);
        showToast('Error deleting file: ' + error.message, 'danger');
    }
}

// Initialize forecasting functionality
document.addEventListener('DOMContentLoaded', function() {
    const forecastingBtn = document.getElementById('forecasting-button');
    const forecastingModal = document.getElementById('forecastingModal');
    const forecastingForm = document.getElementById('forecastingForm');
    const generateForecastBtn = document.getElementById('generateForecastBtn');

    // Add click handler for forecasting button
    if (forecastingBtn) {
        forecastingBtn.addEventListener('click', function() {
            // Show the forecasting modal
            const modal = new bootstrap.Modal(forecastingModal);
            modal.show();

            // Populate column selectors
            populateColumnSelectors();
        });
    }

    // Add click handler for generate forecast button
    if (generateForecastBtn) {
        generateForecastBtn.addEventListener('click', async function() {
            if (!forecastingForm.checkValidity()) {
                forecastingForm.reportValidity();
                return;
            }

            const dateColumn = document.getElementById('dateColumn').value;
            const targetColumn = document.getElementById('targetColumn').value;
            const forecastMethod = document.getElementById('forecastMethod').value;
            const forecastPeriod = parseInt(document.getElementById('forecastPeriod').value);
            const showConfidenceInterval = document.getElementById('showConfidenceInterval').checked;

            if (!dateColumn || !targetColumn) {
                showToast('Please select date and target columns', 'warning');
                return;
            }

            try {
                const response = await fetch('/forecasting/api/generate-forecast/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        date_column: dateColumn,
                        target_column: targetColumn,
                        method: forecastMethod,
                        period: forecastPeriod,
                        show_confidence_interval: showConfidenceInterval,
                        parameters: getMethodParameters(forecastMethod)
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(forecastingModal);
                    modal.hide();

                    // Clear the form
                    forecastingForm.reset();

                    // Show success message
                    showToast('Forecast generated successfully!', 'success');

                    // Update the forecast chart
                    updateForecastChart(result.data);
                } else {
                    throw new Error(result.message || 'Failed to generate forecast');
                }
            } catch (error) {
                console.error('Error generating forecast:', error);
                showToast('Error generating forecast: ' + error.message, 'danger');
            }
        });
    }

    // Function to get method-specific parameters
    function getMethodParameters(method) {
        const parameters = {};
        switch (method) {
            case 'lstm':
                parameters.sequence_length = 10;
                parameters.epochs = 50;
                break;
            case 'arima':
                parameters.p = 1;
                parameters.d = 1;
                parameters.q = 1;
                break;
            case 'prophet':
                parameters.growth = 'linear';
                parameters.seasonality_mode = 'additive';
                break;
        }
        return parameters;
    }

    // Function to populate column selectors
    function populateColumnSelectors() {
        const dateSelect = document.getElementById('dateColumn');
        const targetSelect = document.getElementById('targetColumn');
        const productSelect = document.getElementById('productColumn');
        const exogenousContainer = document.getElementById('exogenousCheckboxes');

        if (!window.availableColumns) {
            console.error('No columns available');
            return;
        }

        // Clear existing options
        dateSelect.innerHTML = '<option value="">Select date column</option>';
        targetSelect.innerHTML = '<option value="">Select target column</option>';
        productSelect.innerHTML = '<option value="">Select product column</option>';
        exogenousContainer.innerHTML = '';

        // Add options for each column
        window.availableColumns.forEach(col => {
            // Add to date select (only datetime columns)
            if (col.type === 'datetime') {
                dateSelect.add(new Option(col.name, col.name));
            }

            // Add to target select (only numeric columns)
            if (col.type === 'numeric') {
                targetSelect.add(new Option(col.name, col.name));
            }

            // Add to product select (all columns)
            productSelect.add(new Option(col.name, col.name));

            // Add to exogenous variables (numeric columns except target)
            if (col.type === 'numeric') {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" value="${col.name}" id="exog_${col.name}">
                    <label class="form-check-label" for="exog_${col.name}">
                        ${col.name}
                    </label>
                `;
                exogenousContainer.appendChild(div);
            }
        });
    }
});

// Function to update the forecast chart
function updateForecastChart(data) {
    const chartContainer = document.getElementById('forecastResults');
    const chartCanvas = document.getElementById('forecastChart');
    const metricsContainer = document.getElementById('modelMetrics');

    // Show the results area
    chartContainer.style.display = 'block';

    // Clear existing chart if any
    if (window.forecastChart) {
        window.forecastChart.destroy();
    }

    // Create the chart
    const ctx = chartCanvas.getContext('2d');
    window.forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [
                {
                    label: 'Historical',
                    data: data.historical,
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    fill: true
                },
                {
                    label: 'Forecast',
                    data: data.forecast,
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Forecast Results'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Value'
                    }
                }
            }
        }
    });

    // Add confidence intervals if available
    if (data.confidence_intervals) {
        window.forecastChart.data.datasets.push({
            label: 'Upper Bound',
            data: data.confidence_intervals.upper,
            borderColor: 'rgba(144, 202, 249, 0.5)',
            borderDash: [5, 5],
            fill: false
        });
        window.forecastChart.data.datasets.push({
            label: 'Lower Bound',
            data: data.confidence_intervals.lower,
            borderColor: 'rgba(144, 202, 249, 0.5)',
            borderDash: [5, 5],
            fill: '-1'
        });
        window.forecastChart.update();
    }

    // Update metrics if available
    if (data.metrics) {
        const metrics = data.metrics;
        metricsContainer.innerHTML = `
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">MAE</h6>
                        <h4 class="card-title">${metrics.mae.toFixed(4)}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">MSE</h6>
                        <h4 class="card-title">${metrics.mse.toFixed(4)}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">RMSE</h6>
                        <h4 class="card-title">${metrics.rmse.toFixed(4)}</h4>
                    </div>
                </div>
            </div>
        `;
    }
}

// ... rest of your existing JavaScript code ...

// Function to update saved files list
async function updateSavedFilesList() {
    console.log('Updating saved files list...');
    const savedFilesContent = document.getElementById('savedFilesContent');
    const savedFilesCount = document.getElementById('savedFilesCount');
    
    if (!savedFilesContent) {
        console.error('savedFilesContent element not found!');
        return;
    }

    try {
        savedFilesContent.innerHTML = '<div class="dropdown-item text-center text-muted py-2">Loading...</div>';
        
        const response = await fetch('/business/api/get-saved-files/');
        const result = await response.json();
        console.log('Saved files API response:', result);

        if (result.status === 'success') {
            const files = result.data;
            savedFilesContent.innerHTML = '';

            if (savedFilesCount) {
                savedFilesCount.textContent = files.length;
            }

            if (files.length === 0) {
                savedFilesContent.innerHTML = `
                    <div class="dropdown-item text-center text-muted py-2">No saved files</div>
                `;
                return;
            }

            const filesList = document.createElement('div');
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'saved-file-item';
                fileItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1" style="cursor: pointer;" onclick="handleLoadFile('${file.id}', '${file.filename}')">
                            <div class="fw-medium">${file.filename}</div>
                            <small class="text-muted d-block">${file.description || 'No description'}</small>
                            <small class="text-muted">${new Date(file.upload_date).toLocaleString()}</small>
                        </div>
                        <div class="d-flex align-items-start">
                            <span class="badge bg-info me-2">${Object.keys(file.column_types).length} cols</span>
                            <button class="btn btn-link btn-sm p-0 delete-btn" onclick="handleDeleteFile(event, '${file.id}', '${file.filename}')" title="Delete file">
                                <i class="fas fa-trash-alt text-danger"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                filesList.appendChild(fileItem);

                if (index < files.length - 1) {
                    const divider = document.createElement('div');
                    divider.className = 'dropdown-divider';
                    filesList.appendChild(divider);
                }
            });
            
            savedFilesContent.appendChild(filesList);
        } else {
            throw new Error(result.message || 'Failed to load saved files');
        }
    } catch (error) {
        console.error('Error loading saved files:', error);
        savedFilesContent.innerHTML = `
            <div class="dropdown-item text-center text-danger py-2">Error loading files</div>
        `;
    }
}
</script>
{% endblock %} 