{% extends 'base.html' %}
{% load static %}

{% block title %}Add Data - Smart-Buiz{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row mb-3 mx-0">
        <div class="col px-3">
            <div class="btn-group" role="group" aria-label="View Controls">
                <button type="button" class="btn btn-outline-primary view-button active" data-view="data" onclick="switchView('data')" style="border-color: #667eea; color: #667eea;">Data View</button>
                <button type="button" class="btn btn-outline-primary view-button" data-view="visualization" onclick="switchView('visualization')" style="border-color: #667eea; color: #667eea;">Visualization</button>
                <button type="button" class="btn btn-outline-primary view-button" data-view="forecast" onclick="switchView('forecast')" style="border-color: #667eea; color: #667eea;">Forecast</button>
            </div>
        </div>
    </div>

    <!-- Data View -->
    <div id="data-view" class="view-content">
        <div class="row mx-0 px-3">
            <!-- Main Content Area -->
            <div class="col-lg-8">
                <!-- File Upload Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-upload me-2"></i>Upload Data
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="file" class="form-control" id="csvFile" accept=".csv" />
                            <div class="form-text">Upload a CSV file to analyze your data</div>
                        </div>
                        <button class="btn btn-primary" id="uploadBtn" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">
                            <i class="fas fa-cloud-upload-alt me-2"></i>Upload and Process
                        </button>
                    </div>
                </div>

                <!-- Data Preview Section -->
                <div class="card mb-4" id="dataPreviewCard" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Data Preview
                        </h5>
                        <span class="badge" id="dataRowCount" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">0 rows</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-striped table-hover" id="dataTable">
                                <thead class="table-dark" id="dataTableHead">
                                    <!-- Dynamic headers -->
                                </thead>
                                <tbody id="dataTableBody">
                                    <!-- Dynamic data -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination Controls -->
                        <div class="d-flex justify-content-between align-items-center mt-3" id="paginationControls" style="display: none;">
                            <div class="d-flex align-items-center">
                                <label for="rowsPerPage" class="form-label me-2 mb-0">Rows per page:</label>
                                <select class="form-select form-select-sm" id="rowsPerPage" style="width: auto;">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <div class="d-flex align-items-center">
                                <span id="pageInfo" class="me-3 text-muted">Page 1 of 1</span>
                                <div class="d-flex align-items-center me-3">
                                    <label for="pageJump" class="form-label me-2 mb-0 small">Go to:</label>
                                    <input type="number" class="form-control form-control-sm" id="pageJump" min="1" max="1" style="width: 60px;" placeholder="Page">
                                </div>
                                <nav aria-label="Table pagination">
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item" id="firstPage">
                                            <a class="page-link" href="#" style="border-color: #667eea; color: #667eea;" title="First Page">
                                                <i class="fas fa-angle-double-left"></i>
                                            </a>
                                        </li>
                                        <li class="page-item" id="prevPage">
                                            <a class="page-link" href="#" style="border-color: #667eea; color: #667eea;" title="Previous Page">
                                                <i class="fas fa-chevron-left"></i>
                                            </a>
                                        </li>
                                        <li class="page-item" id="nextPage">
                                            <a class="page-link" href="#" style="border-color: #667eea; color: #667eea;" title="Next Page">
                                                <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                        <li class="page-item" id="lastPage">
                                            <a class="page-link" href="#" style="border-color: #667eea; color: #667eea;" title="Last Page">
                                                <i class="fas fa-angle-double-right"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Saved Files Section -->
                <div class="card" id="savedFilesCard">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-folder me-2"></i>Saved Files
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="savedFilesList">
                            {% for file in saved_files %}
                            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                <div>
                                    <strong>{{ file.filename }}</strong>
                                    <small class="text-muted d-block">{{ file.description|default:"No description" }}</small>
                                    <small class="text-muted">Uploaded: {{ file.upload_date|date:"M d, Y H:i" }}</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="loadSavedFile('{{ file.id }}')" style="border-color: #667eea; color: #667eea;">
                                        <i class="fas fa-download"></i> Load
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSavedFile('{{ file.id }}')" style="border-color: #e53e3e; color: #e53e3e;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-muted">No saved files found.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="col-lg-4">
                <!-- Column Information Panel -->
                <div class="card mb-4" id="columnsPanel" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-columns me-2"></i>Columns
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="columnsList">
                            <!-- Dynamic column list -->
                        </div>
                    </div>
                </div>

                <!-- Filters Panel -->
                <div class="card mb-4" id="filtersPanel" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-filter me-2"></i>Filters
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" id="addFilterBtn" style="border-color: #667eea; color: #667eea;">
                            <i class="fas fa-plus"></i> Add Filter
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="filtersList">
                            <!-- Dynamic filters -->
                        </div>

                    </div>
                </div>

                <!-- Grouping Panel -->
                <div class="card mb-4" id="groupingPanel" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-layer-group me-2"></i>Group By
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" id="toggleGroupingBtn" style="border-color: #667eea; color: #667eea;">
                            <i class="fas fa-toggle-off me-1"></i>Enable
                        </button>
                    </div>
                    <div class="card-body" id="groupingControls">
                        <div class="alert alert-info d-flex align-items-center" id="groupingInstructions">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>Click "Enable" to activate grouping functionality</small>
                        </div>
                        <div class="mb-3" id="groupingFields" style="display: none;">
                            <label for="groupByColumn" class="form-label">Group by Column:</label>
                            <select class="form-select" id="groupByColumn">
                                <option value="">Select column...</option>
                            </select>
                        </div>
                        <div class="mb-3" id="aggregationFields" style="display: none;">
                            <label for="aggregationMethod" class="form-label">Aggregation Method:</label>
                            <select class="form-select" id="aggregationMethod">
                                <option value="avg">Average</option>
                                <option value="sum">Sum</option>
                                <option value="count">Count</option>
                                <option value="min">Minimum</option>
                                <option value="max">Maximum</option>
                            </select>
                        </div>
                        <div class="d-grid" id="clearGroupingBtn" style="display: none;">
                            <button class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-times me-1"></i>Clear Grouping
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Actions Panel -->
                <div class="card" id="actionsPanel" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" id="saveFileBtn" style="background: linear-gradient(135deg, #10b981, #059669); border: none;">
                                <i class="fas fa-save me-2"></i>Save File
                            </button>
                            <button class="btn btn-info" id="generateVisualizationBtn" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">
                                <i class="fas fa-chart-bar me-2"></i>Generate Visualization
                            </button>
                            <button class="btn btn-warning" id="openForecastModalBtn" style="background: linear-gradient(135deg, #f59e0b, #d97706); border: none;">
                                <i class="fas fa-chart-line me-2"></i>Generate Forecast
                            </button>
                            <button class="btn btn-secondary" id="exportDataBtn" style="background: linear-gradient(135deg, #718096, #4a5568); border: none;">
                                <i class="fas fa-download me-2"></i>Export Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Visualization View -->
    <div id="visualization-view" class="view-content" style="display: none;">
        <div class="row mx-0 px-3">
            <!-- Available Columns -->
            <div class="col-lg-2">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-columns me-2"></i>Available Columns
                        </h5>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="availableColumns" class="list-group">
                            <!-- Dynamic columns will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart Configuration Panel -->
            <div class="col-lg-2">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>Chart Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Chart Type Selection -->
                        <div class="mb-3">
                            <label for="chartType" class="form-label">Chart Type</label>
                            <select class="form-select" id="chartType">
                                <option value="bar">Bar Chart</option>
                                <option value="line">Line Chart</option>
                                <option value="pie">Pie Chart</option>
                                <option value="doughnut">Doughnut Chart</option>
                                <option value="scatter">Scatter Plot</option>
                                <option value="area">Area Chart</option>
                            </select>
                        </div>

                        <!-- X-Axis Drop Zone -->
                        <div class="mb-3">
                            <label class="form-label">X-Axis</label>
                            <div id="xAxisDropZone" class="drop-zone border rounded p-3 text-center" ondrop="drop(event, 'x-axis')" ondragover="allowDrop(event)">
                                <i class="fas fa-plus-circle text-muted me-2"></i>
                                <span class="text-muted">Drag a column here for X-axis</span>
                                <div id="xAxisColumn" class="dropped-column" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- Y-Axis Drop Zone -->
                        <div class="mb-3">
                            <label class="form-label">Y-Axis</label>
                            <div id="yAxisDropZone" class="drop-zone border rounded p-3 text-center" ondrop="drop(event, 'y-axis')" ondragover="allowDrop(event)">
                                <i class="fas fa-plus-circle text-muted me-2"></i>
                                <span class="text-muted">Drag a column here for Y-axis</span>
                                <div id="yAxisColumn" class="dropped-column" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- Color/Category Drop Zone (Optional) -->
                        <div class="mb-3">
                            <label class="form-label">Color/Category <small class="text-muted">(Optional)</small></label>
                            <div id="colorDropZone" class="drop-zone border rounded p-3 text-center" ondrop="drop(event, 'color')" ondragover="allowDrop(event)">
                                <i class="fas fa-plus-circle text-muted me-2"></i>
                                <span class="text-muted">Drag a column here for color grouping</span>
                                <div id="colorColumn" class="dropped-column" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- Aggregation Method (for grouped data) -->
                        <div class="mb-3">
                            <label for="vizAggregationMethod" class="form-label">Aggregation Method</label>
                            <select class="form-select" id="vizAggregationMethod">
                                <option value="sum">Sum</option>
                                <option value="avg">Average</option>
                                <option value="count">Count</option>
                                <option value="min">Minimum</option>
                                <option value="max">Maximum</option>
                            </select>
                        </div>

                        <!-- Generate Chart Button -->
                        <div class="d-grid">
                            <button class="btn btn-primary" id="generateChartBtn" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">
                                <i class="fas fa-chart-bar me-2"></i>Generate Chart
                            </button>
                        </div>

                        <!-- Clear Configuration Button -->
                        <div class="d-grid mt-2">
                            <button class="btn btn-outline-secondary" id="clearChartBtn" style="border-color: #718096; color: #718096;">
                                <i class="fas fa-trash me-2"></i>Clear Configuration
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart Display Area -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Chart Visualization
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" id="downloadChartBtn" style="display: none; border-color: #667eea; color: #667eea;">
                                <i class="fas fa-download me-1"></i>Download
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="fullScreenChartBtn" style="display: none; border-color: #718096; color: #718096;">
                                <i class="fas fa-expand me-1"></i>Full Screen
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="chartContainer" style="height: 500px; display: flex; align-items: center; justify-content: center;">
                            <div class="text-center text-muted">
                                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                <h5>Configure Chart Settings</h5>
                                <p>Drag columns to X-axis and Y-axis areas, select chart type, then click "Generate Chart"</p>
                            </div>
                            <canvas id="visualizationChart" style="display: none;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Chart Statistics Panel -->
                <div class="card mt-4" id="chartStatsPanel" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Chart Statistics
                        </h5>
                    </div>
                    <div class="card-body" id="chartStatsContent">
                        <!-- Dynamic statistics content -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Forecast View -->
    <div id="forecast-view" class="view-content" style="display: none;">
        <div class="row mx-0 px-3">
            <div class="col-12">
                <!-- Forecast Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4>
                        <i class="fas fa-chart-line me-2" style="color: #667eea;"></i>Smart-Buiz Forecasting
                    </h4>
                    <button class="btn btn-primary" id="newForecastBtn" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">
                        <i class="fas fa-plus me-2"></i>New Forecast
                    </button>
                </div>

                <!-- Quick Stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card" style="border-left: 4px solid #667eea;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Total Forecasts</h6>
                                <h2 class="card-title mb-0" id="totalForecasts">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card" style="border-left: 4px solid #10b981;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Active Models</h6>
                                <h2 class="card-title mb-0" id="activeModels">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card" style="border-left: 4px solid #f59e0b;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Best Model</h6>
                                <h5 class="card-title mb-0" id="bestModel">-</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card" style="border-left: 4px solid #6366f1;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Latest Forecast</h6>
                                <h5 class="card-title mb-0" id="latestForecast">-</h5>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Forecast Content -->
                <div class="row">
                    <!-- Forecast Models List -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-list me-2"></i>Forecast Models
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="list-group" id="forecastModelsList">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                                        <p>No forecast models yet</p>
                                        <small>Create your first forecast to get started</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Forecast Details -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-area me-2"></i>Forecast Details
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="forecastChartContainer" style="height: 400px; display: flex; align-items: center; justify-content: center;">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                                        <h5>No Forecast Selected</h5>
                                        <p>Select a forecast model from the left panel to view details</p>
                                    </div>
                                    <canvas id="forecastChart" style="display: none;"></canvas>
                                </div>
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-cogs me-2"></i>Model Parameters</h6>
                                        <div id="modelParameters">
                                            <p class="text-muted">Select a model to view details</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-chart-bar me-2"></i>Performance Metrics</h6>
                                        <div id="modelMetrics">
                                            <p class="text-muted">Select a model to view metrics</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save File Modal -->
<div class="modal fade" id="saveFileModal" tabindex="-1" aria-labelledby="saveFileModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveFileModalLabel">Save File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saveFileForm">
                    <div class="mb-3">
                        <label for="fileName" class="form-label">File Name</label>
                        <input type="text" class="form-control" id="fileName" required>
                    </div>
                    <div class="mb-3">
                        <label for="fileDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="fileDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: linear-gradient(135deg, #718096, #4a5568); border: none;">Close</button>
                <button type="button" class="btn btn-primary" id="confirmSaveBtn" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">Save File</button>
            </div>
        </div>
    </div>
</div>

<!-- New Forecast Modal -->
<div class="modal fade" id="newForecastModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>Create New Forecast
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newForecastForm">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-tag me-2"></i>Model Name
                        </label>
                        <input type="text" class="form-control" name="name" required placeholder="Enter forecast model name">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-database me-2"></i>Data Source
                        </label>
                        <select class="form-control" name="dataSource" required>
                            <option value="current">Use Current Data</option>
                            <option value="upload">Upload New Data</option>
                        </select>
                    </div>

                    <div id="uploadSection" class="mb-3" style="display: none;">
                        <label class="form-label">
                            <i class="fas fa-upload me-2"></i>Upload Data (CSV)
                        </label>
                        <input type="file" class="form-control" name="dataFile" accept=".csv">
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-calendar me-2"></i>Date Column
                                    <small class="text-muted">(date/datetime columns only)</small>
                                </label>
                                <select class="form-control" name="dateColumn" required>
                                    <option value="">Select date column</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-crosshairs me-2"></i>Target Column
                                    <small class="text-muted">(numeric columns only)</small>
                                </label>
                                <select class="form-control" name="targetColumn" required>
                                    <option value="">Select target column</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-brain me-2"></i>Forecasting Method
                        </label>
                        <select class="form-control" name="method" required>
                            <option value="">Select method</option>
                            <option value="lstm">LSTM Neural Network</option>
                            <option value="arima">ARIMA</option>
                            <option value="prophet">Prophet</option>
                        </select>
                    </div>

                    <!-- LSTM Parameters -->
                    <div class="parameter-group" id="lstmParams" style="display: none;">
                        <h6><i class="fas fa-sliders-h me-2"></i>LSTM Parameters</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Sequence Length</label>
                                    <input type="number" class="form-control" name="lstmSequenceLength" value="10" min="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Epochs</label>
                                    <input type="number" class="form-control" name="lstmEpochs" value="50" min="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ARIMA Parameters -->
                    <div class="parameter-group" id="arimaParams" style="display: none;">
                        <h6><i class="fas fa-sliders-h me-2"></i>ARIMA Parameters</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">p (AR)</label>
                                    <input type="number" class="form-control" name="arimaP" value="1" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">d (Differencing)</label>
                                    <input type="number" class="form-control" name="arimaD" value="1" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">q (MA)</label>
                                    <input type="number" class="form-control" name="arimaQ" value="1" min="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prophet Parameters -->
                    <div class="parameter-group" id="prophetParams" style="display: none;">
                        <h6><i class="fas fa-sliders-h me-2"></i>Prophet Parameters</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Growth</label>
                                    <select class="form-control" name="prophetGrowth">
                                        <option value="linear">Linear</option>
                                        <option value="logistic">Logistic</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Seasonality Mode</label>
                                    <select class="form-control" name="prophetSeasonality">
                                        <option value="additive">Additive</option>
                                        <option value="multiplicative">Multiplicative</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-clock me-2"></i>Forecast Period (days)
                        </label>
                        <input type="number" class="form-control" name="period" value="30" min="1" max="365" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generateForecastModalBtn" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">
                    <i class="fas fa-play me-2"></i>Generate Forecast
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Drag and Drop Styles */
    .drop-zone {
        min-height: 60px;
        border: 2px dashed #dee2e6 !important;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .drop-zone:hover {
        border-color: #667eea !important;
        background-color: rgba(102, 126, 234, 0.05);
    }

    .drop-zone.drag-over {
        border-color: #667eea !important;
        background-color: rgba(102, 126, 234, 0.1);
        transform: scale(1.02);
    }

    .draggable-column {
        cursor: grab;
        transition: all 0.3s ease;
        user-select: none;
    }

    .draggable-column:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .draggable-column:active {
        cursor: grabbing;
    }

    .dropped-column {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 500;
    }

    .dropped-column .remove-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .dropped-column .remove-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .column-type-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
    }

    /* Chart container styles */
    #chartContainer {
        position: relative;
    }

    .chart-placeholder {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
    }

    /* Animation styles */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }

    /* Smart-Buiz Theme Colors */
    .view-button.active {
        background: linear-gradient(135deg, #667eea, #764ba2) !important;
        border-color: #667eea !important;
        color: white !important;
    }

    .view-button:hover:not(.active) {
        background: rgba(102, 126, 234, 0.1) !important;
        border-color: #667eea !important;
        color: #667eea !important;
    }

    .table-dark {
        background: linear-gradient(135deg, #667eea, #764ba2) !important;
    }

    .card-header {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
        border-bottom: 2px solid #667eea !important;
    }

    .card-header h5 {
        color: #2d3748 !important;
    }

    /* Pagination styles */
    .page-link {
        transition: all 0.2s ease;
    }
    
    .page-link:hover:not(.disabled .page-link) {
        background: linear-gradient(135deg, #667eea, #764ba2) !important;
        border-color: #667eea !important;
        color: white !important;
    }
    
    .page-item.disabled .page-link {
        opacity: 0.5;
        pointer-events: none;
    }
    
    #rowsPerPage {
        min-width: 60px;
    }
    
    #pageInfo {
        font-size: 0.9rem;
        white-space: nowrap;
    }
    
    #pageJump {
        transition: border-color 0.2s ease;
    }
    
    #pageJump:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .alert-info {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        border-color: #667eea;
        color: #495057;
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
        .drop-zone {
            min-height: 50px;
        }
        
        #chartContainer {
            height: 400px !important;
        }
        
        #paginationControls {
            flex-direction: column;
            gap: 1rem;
        }
        
        #paginationControls > div {
            justify-content: center;
        }
        
        #pageJump {
            width: 80px !important;
        }
        
        .pagination {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global variables
    let currentData = null;
    let currentColumns = [];
    let visualizationChart = null;
    let forecastChart = null;
    let currentFilters = [];
    
    // Pagination variables
    let currentPage = 1;
    let rowsPerPage = 10;
    let totalRows = 0;
    let totalPages = 0;
    let currentDisplayData = null;
    
    // Grouping state
    let isGroupingEnabled = false;
    let originalData = null;
    
    // Filtering state
    let isFiltered = false;
    let currentFiltersForPagination = [];

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeEventListeners();
    });

    function initializeEventListeners() {
        // File upload
        const uploadBtn = document.getElementById('uploadBtn');
        const csvFile = document.getElementById('csvFile');
        
        if (uploadBtn) {
            uploadBtn.addEventListener('click', handleFileUpload);
        }

        // Add filter button
        const addFilterBtn = document.getElementById('addFilterBtn');
        if (addFilterBtn) {
            addFilterBtn.addEventListener('click', addNewFilter);
        }

        // Auto-apply filters and grouping event listeners
        setupAutoApplyListeners();

        // Add grouping auto-apply listeners
        const groupByColumn = document.getElementById('groupByColumn');
        const aggregationMethod = document.getElementById('aggregationMethod');
        
        if (groupByColumn) {
            groupByColumn.addEventListener('change', autoApplyGrouping);
        }
        
        if (aggregationMethod) {
            aggregationMethod.addEventListener('change', autoApplyGrouping);
        }

        // Save file button
        const saveFileBtn = document.getElementById('saveFileBtn');
        if (saveFileBtn) {
            saveFileBtn.addEventListener('click', openSaveModal);
        }

        // Open forecast view button
        const openForecastModalBtn = document.getElementById('openForecastModalBtn');
        if (openForecastModalBtn) {
            openForecastModalBtn.addEventListener('click', switchToForecastView);
        }

        // Generate visualization button (old one in actions panel)
        const generateVisualizationBtn = document.getElementById('generateVisualizationBtn');
        if (generateVisualizationBtn) {
            generateVisualizationBtn.addEventListener('click', () => {
                switchView('visualization');
                populateAvailableColumns();
            });
        }

        // Generate chart button (new one in visualization panel)
        const generateChartBtn = document.getElementById('generateChartBtn');
        if (generateChartBtn) {
            generateChartBtn.addEventListener('click', generateChart);
        }

        // Clear chart button
        const clearChartBtn = document.getElementById('clearChartBtn');
        if (clearChartBtn) {
            clearChartBtn.addEventListener('click', clearChartConfiguration);
        }

        // Download chart button
        const downloadChartBtn = document.getElementById('downloadChartBtn');
        if (downloadChartBtn) {
            downloadChartBtn.addEventListener('click', downloadChart);
        }

        // Confirm save button
        const confirmSaveBtn = document.getElementById('confirmSaveBtn');
        if (confirmSaveBtn) {
            confirmSaveBtn.addEventListener('click', saveCurrentFile);
        }

        // New forecast button (in forecast view)
        const newForecastBtn = document.getElementById('newForecastBtn');
        if (newForecastBtn) {
            newForecastBtn.addEventListener('click', function() {
                openNewForecastModal();
            });
        }

        // Generate forecast button (in modal)
        const generateForecastModalBtn = document.getElementById('generateForecastModalBtn');
        if (generateForecastModalBtn) {
            generateForecastModalBtn.addEventListener('click', handleGenerateForecast);
        }

        // Forecast model selection
        const forecastModelsList = document.getElementById('forecastModelsList');
        if (forecastModelsList) {
            forecastModelsList.addEventListener('click', function(e) {
                const modelItem = e.target.closest('.list-group-item-action');
                if (modelItem) {
                    e.preventDefault();
                    const modelId = modelItem.dataset.modelId;
                    selectForecastModel(modelId);
                }
            });
        }

        // Forecast method change handler
        const methodSelect = document.querySelector('select[name="method"]');
        if (methodSelect) {
            methodSelect.addEventListener('change', function() {
                // Hide all parameter groups
                document.querySelectorAll('.parameter-group').forEach(group => {
                    group.style.display = 'none';
                });

                // Show selected method's parameters
                const selectedMethod = this.value;
                if (selectedMethod) {
                    const paramGroup = document.getElementById(`${selectedMethod}Params`);
                    if (paramGroup) {
                        paramGroup.style.display = 'block';
                    }
                }
            });
        }

        // Data source change handler
        const dataSourceSelect = document.querySelector('select[name="dataSource"]');
        if (dataSourceSelect) {
            dataSourceSelect.addEventListener('change', function() {
                const uploadSection = document.getElementById('uploadSection');
                if (uploadSection) {
                    uploadSection.style.display = this.value === 'upload' ? 'block' : 'none';
                }
            });
        }

        // Pagination event listeners
        const rowsPerPage = document.getElementById('rowsPerPage');
        const firstPage = document.getElementById('firstPage');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const lastPage = document.getElementById('lastPage');
        const pageJump = document.getElementById('pageJump');
        
        if (rowsPerPage) {
            rowsPerPage.addEventListener('change', handleRowsPerPageChange);
        }
        
        if (firstPage) {
            firstPage.addEventListener('click', handleFirstPage);
        }
        
        if (prevPage) {
            prevPage.addEventListener('click', handlePrevPage);
        }
        
        if (nextPage) {
            nextPage.addEventListener('click', handleNextPage);
        }
        
        if (lastPage) {
            lastPage.addEventListener('click', handleLastPage);
        }
        
        if (pageJump) {
            pageJump.addEventListener('keypress', handlePageJump);
            pageJump.addEventListener('change', handlePageJumpChange);
        }

        // Group by toggle event listener
        const toggleGroupingBtn = document.getElementById('toggleGroupingBtn');
        if (toggleGroupingBtn) {
            toggleGroupingBtn.addEventListener('click', handleToggleGrouping);
        }

        // Clear grouping event listener
        const clearGroupingBtn = document.getElementById('clearGroupingBtn');
        if (clearGroupingBtn) {
            clearGroupingBtn.addEventListener('click', handleClearGrouping);
        }

        // Export data event listener
        const exportDataBtn = document.getElementById('exportDataBtn');
        if (exportDataBtn) {
            exportDataBtn.addEventListener('click', handleExportData);
        }
    }

    // Function to switch views
    function switchView(viewName) {
        // Hide all views
        document.querySelectorAll('.view-content').forEach(view => {
            view.style.display = 'none';
        });
        
        // Show selected view
        const selectedView = document.getElementById(`${viewName}-view`);
        if (selectedView) {
            selectedView.style.display = 'block';
            
            // If switching to visualization view, update the chart
            if (viewName === 'visualization' && visualizationChart) {
                visualizationChart.update();
            }
            // If switching to forecast view, update the forecast chart
            if (viewName === 'forecast' && forecastChart) {
                forecastChart.update();
            }
        }
        
        // Update active state of view buttons
        document.querySelectorAll('.view-button').forEach(button => {
            button.classList.remove('active');
        });
        document.querySelector(`button[data-view="${viewName}"]`).classList.add('active');
    }

    async function handleFileUpload() {
        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];
        
        if (!file) {
            showToast('Please select a CSV file', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            showLoading('Uploading and processing file...');
            
            const response = await fetch('/business/api/upload-data/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                currentData = data.data;
                displayDataPreview(data.data);
                setupColumns(data.data.columns, data.data.column_types);
                showPanels();
                showToast('File uploaded successfully!', 'success');
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            showToast('Error uploading file: ' + error.message, 'danger');
        } finally {
            hideLoading();
        }
    }

    function displayDataPreview(data) {
        const previewCard = document.getElementById('dataPreviewCard');
        const tableHead = document.getElementById('dataTableHead');
        const tableBody = document.getElementById('dataTableBody');
        const rowCount = document.getElementById('dataRowCount');
        const paginationControls = document.getElementById('paginationControls');

        // Show preview card
        previewCard.style.display = 'block';
        
        // Store data for pagination
        currentDisplayData = data;
        originalData = JSON.parse(JSON.stringify(data)); // Store original data for grouping reset
        totalRows = data.total_rows || data.data.length;
        totalPages = Math.ceil(totalRows / rowsPerPage);
        currentPage = 1;
        
        // Reset filtering state
        isFiltered = false;
        currentFiltersForPagination = [];

        // Update row count
        rowCount.textContent = `${totalRows} rows`;

        // Create table headers
        const headerRow = document.createElement('tr');
        data.columns.forEach(column => {
            const th = document.createElement('th');
            th.textContent = column;
            headerRow.appendChild(th);
        });
        tableHead.innerHTML = '';
        tableHead.appendChild(headerRow);

        // Show pagination controls if there's more than one page
        if (totalPages > 1) {
            paginationControls.style.display = 'flex';
        } else {
            paginationControls.style.display = 'none';
        }

        // Display the first page
        displayTablePage();
    }

    async function displayTablePage() {
        const tableBody = document.getElementById('dataTableBody');
        const pageInfo = document.getElementById('pageInfo');
        const firstPage = document.getElementById('firstPage');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const lastPage = document.getElementById('lastPage');
        const pageJump = document.getElementById('pageJump');

        if (!currentDisplayData) return;

        let pageData = [];

        // If we have filtered data and too many results for local pagination
        if (isFiltered && currentFiltersForPagination.length > 0 && totalRows > currentDisplayData.data.length) {
            // For now, show empty rows with a message to indicate we need to fetch more data
            // This is a placeholder until server-side pagination is implemented
            if (currentPage === 1) {
                pageData = currentDisplayData.data.slice(0, rowsPerPage);
            } else {
                // Show placeholder message for other pages
                pageData = [];
                const tableBody = document.getElementById('dataTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${currentDisplayData.columns.length}" class="text-center py-4">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-info-circle text-muted mb-2" style="font-size: 2rem;"></i>
                                <p class="text-muted mb-2">Showing filtered results (Page ${currentPage} of ${totalPages})</p>
                                <p class="small text-muted">Only first page data is available in preview mode</p>
                                <button class="btn btn-sm btn-outline-primary" onclick="currentPage = 1; displayTablePage();" style="border-color: #667eea; color: #667eea;">
                                    <i class="fas fa-arrow-left me-1"></i>Back to Page 1
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Update page info and return early
                const pageInfo = document.getElementById('pageInfo');
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                
                // Update pagination buttons
                updatePaginationButtons();
                return;
            }
        } else {
            // Use local data for unfiltered or grouped data
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, totalRows);
            pageData = currentDisplayData.data.slice(startIndex, endIndex);
        }

        // Clear table body
        tableBody.innerHTML = '';

        // Populate table with current page data
        pageData.forEach(row => {
            const tr = document.createElement('tr');
            currentDisplayData.columns.forEach(column => {
                const td = document.createElement('td');
                td.textContent = row[column] || '';
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });

        // Update page info
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

        // Update page jump input
        if (pageJump) {
            pageJump.max = totalPages;
            pageJump.value = '';
            pageJump.placeholder = currentPage.toString();
        }

        // Update pagination buttons
        updatePaginationButtons();
    }

    function updatePaginationButtons() {
        const firstPage = document.getElementById('firstPage');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const lastPage = document.getElementById('lastPage');

        const isFirstPage = currentPage === 1;
        const isLastPage = currentPage === totalPages || totalPages === 0;

        if (firstPage) {
            if (isFirstPage) {
                firstPage.classList.add('disabled');
            } else {
                firstPage.classList.remove('disabled');
            }
        }

        if (prevPage) {
            if (isFirstPage) {
                prevPage.classList.add('disabled');
            } else {
                prevPage.classList.remove('disabled');
            }
        }

        if (nextPage) {
            if (isLastPage) {
                nextPage.classList.add('disabled');
            } else {
                nextPage.classList.remove('disabled');
            }
        }

        if (lastPage) {
            if (isLastPage) {
                lastPage.classList.add('disabled');
            } else {
                lastPage.classList.remove('disabled');
            }
        }
    }

    function handleRowsPerPageChange() {
        rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
        totalPages = Math.ceil(totalRows / rowsPerPage);
        currentPage = 1; // Reset to first page
        
        const paginationControls = document.getElementById('paginationControls');
        if (totalPages > 1) {
            paginationControls.style.display = 'flex';
        } else {
            paginationControls.style.display = 'none';
        }
        
        displayTablePage();
    }

    function handlePrevPage(e) {
        e.preventDefault();
        if (currentPage > 1) {
            currentPage--;
            displayTablePage();
        }
    }

    function handleFirstPage(e) {
        e.preventDefault();
        if (currentPage > 1) {
            currentPage = 1;
            displayTablePage();
        }
    }

    function handleNextPage(e) {
        e.preventDefault();
        if (currentPage < totalPages) {
            currentPage++;
            displayTablePage();
        }
    }

    function handleLastPage(e) {
        e.preventDefault();
        if (currentPage < totalPages) {
            currentPage = totalPages;
            displayTablePage();
        }
    }

    function handlePageJump(e) {
        if (e.key === 'Enter') {
            const targetPage = parseInt(e.target.value);
            if (targetPage >= 1 && targetPage <= totalPages) {
                currentPage = targetPage;
                displayTablePage();
                e.target.value = '';
            } else {
                showToast(`Please enter a page number between 1 and ${totalPages}`, 'warning');
                e.target.value = '';
            }
        }
    }

    function handlePageJumpChange(e) {
        const targetPage = parseInt(e.target.value);
        if (targetPage >= 1 && targetPage <= totalPages) {
            currentPage = targetPage;
            displayTablePage();
            e.target.value = '';
        } else if (e.target.value !== '') {
            showToast(`Please enter a page number between 1 and ${totalPages}`, 'warning');
            e.target.value = '';
        }
    }

    function handleToggleGrouping() {
        const toggleBtn = document.getElementById('toggleGroupingBtn');
        const groupingFields = document.getElementById('groupingFields');
        const aggregationFields = document.getElementById('aggregationFields');
        const clearGroupingBtn = document.getElementById('clearGroupingBtn');
        const groupingInstructions = document.getElementById('groupingInstructions');

        isGroupingEnabled = !isGroupingEnabled;

        if (isGroupingEnabled) {
            // Enable grouping
            toggleBtn.innerHTML = '<i class="fas fa-toggle-on me-1"></i>Disable';
            toggleBtn.classList.remove('btn-outline-primary');
            toggleBtn.classList.add('btn-primary');
            toggleBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            toggleBtn.style.borderColor = '#667eea';
            
            groupingFields.style.display = 'block';
            aggregationFields.style.display = 'block';
            groupingInstructions.style.display = 'none';
            
            // Store original data if not already stored
            if (!originalData && currentDisplayData) {
                originalData = JSON.parse(JSON.stringify(currentDisplayData));
            }
        } else {
            // Disable grouping
            toggleBtn.innerHTML = '<i class="fas fa-toggle-off me-1"></i>Enable';
            toggleBtn.classList.remove('btn-primary');
            toggleBtn.classList.add('btn-outline-primary');
            toggleBtn.style.background = '';
            toggleBtn.style.borderColor = '#667eea';
            toggleBtn.style.color = '#667eea';
            
            groupingFields.style.display = 'none';
            aggregationFields.style.display = 'none';
            clearGroupingBtn.style.display = 'none';
            groupingInstructions.style.display = 'block';
            
            // Reset to original data
            if (originalData) {
                currentDisplayData = JSON.parse(JSON.stringify(originalData));
                totalRows = currentDisplayData.data.length;
                totalPages = Math.ceil(totalRows / rowsPerPage);
                currentPage = 1;
                
                // Reset table headers to original
                const tableHead = document.getElementById('dataTableHead');
                const headerRow = document.createElement('tr');
                currentDisplayData.columns.forEach(column => {
                    const th = document.createElement('th');
                    th.textContent = column;
                    headerRow.appendChild(th);
                });
                tableHead.innerHTML = '';
                tableHead.appendChild(headerRow);
                
                // Update row count
                document.getElementById('dataRowCount').textContent = `${totalRows} rows`;
                
                displayTablePage();
            }
            
            // Reset dropdowns
            document.getElementById('groupByColumn').value = '';
            document.getElementById('aggregationMethod').value = 'avg';
        }
    }

    function handleClearGrouping() {
        // Reset to original data
        if (originalData) {
            currentDisplayData = JSON.parse(JSON.stringify(originalData));
            totalRows = currentDisplayData.data.length;
            totalPages = Math.ceil(totalRows / rowsPerPage);
            currentPage = 1;
            
            // Reset table headers to original
            const tableHead = document.getElementById('dataTableHead');
            const headerRow = document.createElement('tr');
            currentDisplayData.columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headerRow.appendChild(th);
            });
            tableHead.innerHTML = '';
            tableHead.appendChild(headerRow);
            
            // Update row count
            document.getElementById('dataRowCount').textContent = `${totalRows} rows`;
            
            displayTablePage();
            
            // Hide clear button
            document.getElementById('clearGroupingBtn').style.display = 'none';
            
            showToast('Grouping cleared', 'info');
        }
        
        // Reset dropdowns
        document.getElementById('groupByColumn').value = '';
        document.getElementById('aggregationMethod').value = 'avg';
    }

    function handleExportData() {
        if (!currentDisplayData) {
            showToast('No data available to export', 'warning');
            return;
        }

        // Create and show export modal
        showExportModal();
    }

    function showExportModal() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'exportModal';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-download me-2"></i>Export Data
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-4">
                            <h6 class="mb-3">Export Options</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="exportType" id="exportCurrent" value="current" checked>
                                <label class="form-check-label" for="exportCurrent">
                                    <strong>Current View</strong> 
                                    <small class="text-muted d-block">Export data as currently displayed (${isFiltered ? 'filtered' : 'all'} data${isGroupingEnabled ? ', grouped' : ''})</small>
                                </label>
                            </div>
                            <div class="form-check mb-2" ${isFiltered ? '' : 'style="display: none;"'}>
                                <input class="form-check-input" type="radio" name="exportType" id="exportOriginal" value="original">
                                <label class="form-check-label" for="exportOriginal">
                                    <strong>Original Data</strong>
                                    <small class="text-muted d-block">Export complete dataset without filters or grouping</small>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="mb-3">File Format</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="exportFormat" id="formatCSV" value="csv" checked>
                                <label class="form-check-label" for="formatCSV">
                                    <i class="fas fa-file-csv me-2"></i>CSV (Comma Separated Values)
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="exportFormat" id="formatJSON" value="json">
                                <label class="form-check-label" for="formatJSON">
                                    <i class="fas fa-file-code me-2"></i>JSON (JavaScript Object Notation)
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="exportFormat" id="formatExcel" value="excel">
                                <label class="form-check-label" for="formatExcel">
                                    <i class="fas fa-file-excel me-2"></i>Excel (XLSX)
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="exportFilename" class="form-label">Filename</label>
                            <input type="text" class="form-control" id="exportFilename" value="data_export_${new Date().toISOString().split('T')[0]}">
                        </div>

                        <div class="alert alert-info d-flex align-items-center">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>
                                ${isFiltered ? `<strong>${totalRows} filtered rows</strong> will be exported` : `<strong>${totalRows} total rows</strong> will be exported`}
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmExportBtn" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Show modal
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();

        // Handle export button click
        document.getElementById('confirmExportBtn').addEventListener('click', function() {
            const exportType = document.querySelector('input[name="exportType"]:checked').value;
            const exportFormat = document.querySelector('input[name="exportFormat"]:checked').value;
            const filename = document.getElementById('exportFilename').value || 'data_export';

            performExport(exportType, exportFormat, filename);
            bootstrapModal.hide();
        });

        // Clean up modal when hidden
        modal.addEventListener('hidden.bs.modal', function() {
            modal.remove();
        });
    }

    async function performExport(exportType, format, filename) {
        try {
            showLoading('Preparing export...');

            let dataToExport;
            let columns;

            // Determine what data to export
            if (exportType === 'original' && originalData) {
                dataToExport = originalData.data;
                columns = originalData.columns;
            } else {
                // For current view, we need to get all the data, not just the current page
                if (isFiltered && currentFiltersForPagination.length > 0) {
                    // Get all filtered data from server
                    const response = await fetch('/business/api/apply-filters/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ 
                            filters: currentFiltersForPagination,
                            export_all: true // Request all data, not just preview
                        })
                    });

                    const data = await response.json();
                    if (data.status === 'success') {
                        dataToExport = data.data.all_data || data.data.preview;
                        columns = currentDisplayData.columns;
                    } else {
                        throw new Error('Failed to fetch filtered data for export');
                    }
                } else {
                    dataToExport = currentDisplayData.data;
                    columns = currentDisplayData.columns;
                }
            }

            // Export based on format
            switch (format) {
                case 'csv':
                    exportToCSV(dataToExport, columns, filename);
                    break;
                case 'json':
                    exportToJSON(dataToExport, filename);
                    break;
                case 'excel':
                    exportToExcel(dataToExport, columns, filename);
                    break;
                default:
                    throw new Error('Unsupported export format');
            }

            showToast(`Data exported successfully as ${format.toUpperCase()}!`, 'success');

        } catch (error) {
            showToast('Error exporting data: ' + error.message, 'danger');
        } finally {
            hideLoading();
        }
    }

    function exportToCSV(data, columns, filename) {
        // Create CSV content
        const csvContent = [];
        
        // Add headers
        csvContent.push(columns.map(col => `"${col}"`).join(','));
        
        // Add data rows
        data.forEach(row => {
            const csvRow = columns.map(col => {
                const value = row[col] || '';
                // Escape quotes and wrap in quotes if contains comma, quote, or newline
                if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            });
            csvContent.push(csvRow.join(','));
        });

        // Create and download file
        const csvString = csvContent.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        downloadFile(blob, `${filename}.csv`);
    }

    function exportToJSON(data, filename) {
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
        downloadFile(blob, `${filename}.json`);
    }

    function exportToExcel(data, columns, filename) {
        // Create workbook data
        const wsData = [columns]; // Headers
        data.forEach(row => {
            wsData.push(columns.map(col => row[col] || ''));
        });

        // Convert to CSV format (simplified Excel export)
        const csvContent = wsData.map(row => 
            row.map(cell => {
                const value = cell || '';
                if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }).join(',')
        ).join('\n');

        const blob = new Blob([csvContent], { 
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8;' 
        });
        downloadFile(blob, `${filename}.xlsx`);
    }

    function downloadFile(blob, filename) {
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function setupColumns(columns, columnTypes) {
        const columnsList = document.getElementById('columnsList');
        const groupByColumn = document.getElementById('groupByColumn');
        const dateColumn = document.getElementById('dateColumn');
        const targetColumn = document.getElementById('targetColumn');

        // Clear existing options (with null checks)
        if (columnsList) {
            columnsList.innerHTML = '';
        }
        if (groupByColumn) {
            groupByColumn.innerHTML = '<option value="">Select column...</option>';
        }
        if (dateColumn) {
            dateColumn.innerHTML = '<option value="">Select date column</option>';
        }
        if (targetColumn) {
            targetColumn.innerHTML = '<option value="">Select target column</option>';
        }

        // Store columns globally for other functions
        currentColumns = columns;

        columns.forEach(column => {
            // Add to columns list
            if (columnsList) {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'mb-2 p-2 border rounded';
                columnDiv.innerHTML = `
                    <strong>${column}</strong>
                    <span class="badge bg-secondary ms-2" style="background: linear-gradient(135deg, #718096, #4a5568) !important;">${columnTypes[column]}</span>
                `;
                columnsList.appendChild(columnDiv);
            }

            // Add to dropdowns (with null checks)
            if (groupByColumn) {
                const groupOption = new Option(column, column);
                groupByColumn.appendChild(groupOption);
            }

            // Add date columns to date dropdown
            if (dateColumn && columnTypes[column] === 'date') {
                const dateOption = new Option(column, column);
                dateColumn.appendChild(dateOption);
            }

            // Add numeric columns to target dropdown
            if (targetColumn && columnTypes[column] === 'numeric') {
                const targetOption = new Option(column, column);
                targetColumn.appendChild(targetOption);
            }
        });
    }

    function showPanels() {
        document.getElementById('columnsPanel').style.display = 'block';
        document.getElementById('filtersPanel').style.display = 'block';
        document.getElementById('groupingPanel').style.display = 'block';
        document.getElementById('actionsPanel').style.display = 'block';
    }

    function addNewFilter() {
        if (!currentData || !currentData.columns) {
            showToast('Please upload data first', 'warning');
            return;
        }

        const filtersList = document.getElementById('filtersList');
        const filterId = `filter_${Date.now()}`;
        
        const filterDiv = document.createElement('div');
        filterDiv.className = 'mb-3 p-3 border rounded filter-item';
        filterDiv.id = filterId;
        
        filterDiv.innerHTML = `
            <div class="row">
                <div class="col-4">
                    <select class="form-select filter-column">
                        <option value="">Column...</option>
                        ${currentData.columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                    </select>
                </div>
                <div class="col-3">
                    <select class="form-select filter-operator">
                        <option value="==">Equals</option>
                        <option value="!=">Not Equals</option>
                        <option value=">">Greater Than</option>
                        <option value="<">Less Than</option>
                        <option value=">=">Greater or Equal</option>
                        <option value="<=">Less or Equal</option>
                        <option value="contains">Contains</option>
                    </select>
                </div>
                <div class="col-4">
                    <input type="text" class="form-control filter-value" placeholder="Value...">
                </div>
                <div class="col-1">
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFilter('${filterId}')" style="border-color: #e53e3e; color: #e53e3e;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        
        filtersList.appendChild(filterDiv);
        
        // Add auto-apply listeners to the new filter
        setupFilterAutoApply(filterDiv);
    }

    function removeFilter(filterId) {
        const filterElement = document.getElementById(filterId);
        if (filterElement) {
            filterElement.remove();
            // Auto-apply filters after removal
            setTimeout(autoApplyFilters, 100);
        }
    }

    function setupAutoApplyListeners() {
        // Setup listeners for existing filter items
        const existingFilters = document.querySelectorAll('.filter-item');
        existingFilters.forEach(filter => {
            setupFilterAutoApply(filter);
        });
    }

    function setupFilterAutoApply(filterDiv) {
        const column = filterDiv.querySelector('.filter-column');
        const operator = filterDiv.querySelector('.filter-operator');
        const value = filterDiv.querySelector('.filter-value');
        
        [column, operator, value].forEach(element => {
            if (element) {
                element.addEventListener('change', autoApplyFilters);
                element.addEventListener('input', autoApplyFilters);
            }
        });
    }

    function autoApplyFilters() {
        // Debounce the auto-apply to avoid too many requests
        clearTimeout(window.filterTimeout);
        window.filterTimeout = setTimeout(() => {
            const filterItems = document.querySelectorAll('.filter-item');
            let hasCompleteFilters = false;

            // Check if any filter has all fields filled
            filterItems.forEach(item => {
                const column = item.querySelector('.filter-column').value;
                const operator = item.querySelector('.filter-operator').value;
                const value = item.querySelector('.filter-value').value;

                if (column && operator && value) {
                    hasCompleteFilters = true;
                }
            });

            // Only apply filters if there are complete filters or if clearing all filters
            if (hasCompleteFilters) {
                applyFilters();
            } else if (filterItems.length === 0) {
                // Reset to original data when no filters
                if (originalData) {
                    currentDisplayData = JSON.parse(JSON.stringify(originalData));
                    totalRows = currentDisplayData.data.length;
                    totalPages = Math.ceil(totalRows / rowsPerPage);
                    currentPage = 1;
                    isFiltered = false;
                    currentFiltersForPagination = [];
                    
                    // Update row count
                    document.getElementById('dataRowCount').textContent = `${totalRows} rows`;
                    
                    displayTablePage();
                }
            }
        }, 500); // 500ms debounce
    }

    function autoApplyGrouping() {
        if (!isGroupingEnabled) return;
        
        const groupByColumn = document.getElementById('groupByColumn').value;
        const aggregationMethod = document.getElementById('aggregationMethod').value;

        // Auto-apply if both fields are selected
        if (groupByColumn && aggregationMethod) {
            generateVisualizationFromGrouping();
            // Show clear grouping button
            document.getElementById('clearGroupingBtn').style.display = 'block';
        }
    }

    async function generateVisualizationFromGrouping() {
        if (!currentData) {
            showToast('Please upload data first', 'warning');
            return;
        }

        // Get selected grouping options
        const groupByColumn = document.getElementById('groupByColumn').value;
        const aggregationMethod = document.getElementById('aggregationMethod').value;

        // Find numeric column for Y-axis
        const numericColumns = currentData.columns.filter(col => 
            currentData.column_types[col] === 'numeric'
        );

        if (numericColumns.length === 0) {
            showToast('No numeric columns found for visualization', 'warning');
            return;
        }

        try {
            const response = await fetch('/business/api/visualization-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    x_axis: groupByColumn,
                    y_axis: numericColumns[0], // Use first numeric column
                    group_by_x_axis: true,
                    aggregation_method: aggregationMethod,
                    filters: currentFilters
                })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                updateDataTableWithGrouping(data.data, groupByColumn, numericColumns[0], aggregationMethod);
                showToast(`Data grouped by ${groupByColumn} with ${aggregationMethod}`, 'success');
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            showToast('Error applying grouping: ' + error.message, 'danger');
        }
    }

    function updateDataTableWithGrouping(data, groupColumn, valueColumn, aggregationMethod) {
        const tableHead = document.getElementById('dataTableHead');
        const tableBody = document.getElementById('dataTableBody');
        const rowCount = document.getElementById('dataRowCount');
        const paginationControls = document.getElementById('paginationControls');

        // Convert grouped data to table format for pagination
        const groupedTableData = [];
        for (let i = 0; i < data.x.length; i++) {
            const row = {};
            row[groupColumn] = data.x[i];
            row[`${aggregationMethod.toUpperCase()}(${valueColumn})`] = typeof data.y[i] === 'number' ? data.y[i].toFixed(2) : data.y[i];
            groupedTableData.push(row);
        }

        // Update current display data for pagination
        currentDisplayData = {
            columns: [groupColumn, `${aggregationMethod.toUpperCase()}(${valueColumn})`],
            data: groupedTableData
        };
        
        totalRows = data.x.length;
        totalPages = Math.ceil(totalRows / rowsPerPage);
        currentPage = 1;

        // Update headers for grouped data
        const headerRow = document.createElement('tr');
        const groupHeader = document.createElement('th');
        groupHeader.textContent = groupColumn;
        const valueHeader = document.createElement('th');
        valueHeader.textContent = `${aggregationMethod.toUpperCase()}(${valueColumn})`;
        
        headerRow.appendChild(groupHeader);
        headerRow.appendChild(valueHeader);
        tableHead.innerHTML = '';
        tableHead.appendChild(headerRow);

        // Show pagination controls if needed
        if (totalPages > 1) {
            paginationControls.style.display = 'flex';
        } else {
            paginationControls.style.display = 'none';
        }

        // Update row count
        rowCount.textContent = `${data.x.length} groups`;

        // Display the first page
        displayTablePage();
    }

    async function applyFilters() {
        const filterItems = document.querySelectorAll('.filter-item');
        const filters = [];

        filterItems.forEach(item => {
            const column = item.querySelector('.filter-column').value;
            const operator = item.querySelector('.filter-operator').value;
            const value = item.querySelector('.filter-value').value;

            if (column && operator && value) {
                filters.push({ column, operator, value });
            }
        });

        currentFilters = filters;
        currentFiltersForPagination = filters; // Store for pagination

        try {
            const response = await fetch('/business/api/apply-filters/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ filters })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                updateDataPreview(data.data.preview, data.data.row_count);
                document.getElementById('dataRowCount').textContent = `${data.data.row_count} rows (filtered)`;
                showToast('Filters applied successfully!', 'success');
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            showToast('Error applying filters: ' + error.message, 'danger');
        }
    }

    function updateDataPreview(previewData, totalFilteredRows = null) {
        // Update the current display data with filtered data
        if (currentDisplayData) {
            currentDisplayData.data = previewData;
            // Use actual total filtered rows if provided, otherwise use preview data length
            totalRows = totalFilteredRows !== null ? totalFilteredRows : previewData.length;
            totalPages = Math.ceil(totalRows / rowsPerPage);
            currentPage = 1; // Reset to first page
            
            // Set filtering state
            isFiltered = totalFilteredRows !== null && totalFilteredRows !== currentDisplayData.data.length;
            
            // Update pagination controls visibility
            const paginationControls = document.getElementById('paginationControls');
            if (totalPages > 1) {
                paginationControls.style.display = 'flex';
            } else {
                paginationControls.style.display = 'none';
            }
            
            // Display the first page of filtered data
            displayTablePage();
        }
    }

    function openSaveModal() {
        if (!currentData) {
            showToast('Please upload data first', 'warning');
            return;
        }

        const modal = new bootstrap.Modal(document.getElementById('saveFileModal'));
        modal.show();
    }

    async function saveCurrentFile() {
        const fileName = document.getElementById('fileName').value;
        const fileDescription = document.getElementById('fileDescription').value;

        if (!fileName.trim()) {
            showToast('Please enter a file name', 'warning');
            return;
        }

        try {
            const response = await fetch('/business/api/save-file/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    filename: fileName,
                    description: fileDescription,
                    data: currentData
                })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                showToast('File saved successfully!', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('saveFileModal'));
                modal.hide();
                
                // Clear form
                document.getElementById('fileName').value = '';
                document.getElementById('fileDescription').value = '';
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            showToast('Error saving file: ' + error.message, 'danger');
        }
    }

    // Switch to forecast view
    function switchToForecastView() {
        if (!currentData || !currentData.data || currentData.data.length === 0) {
            showToast('Please upload data first', 'warning');
            return;
        }
        
        // Switch to forecast tab
        switchView('forecast');
        
        // Load available forecast models
        loadForecastModels();
    }
    
    // Load forecast models from server or local storage
    function loadForecastModels() {        
        // Update stats
        updateForecastStats();
        
        // Check if there are any saved models
        const savedModels = JSON.parse(localStorage.getItem('forecastModels') || '[]');
        displayForecastModels(savedModels);
    }
    
    // Update forecast stats
    function updateForecastStats() {
        const savedModels = JSON.parse(localStorage.getItem('forecastModels') || '[]');
        
        const totalForecastsEl = document.getElementById('totalForecasts');
        const activeModelsEl = document.getElementById('activeModels');
        const bestModelEl = document.getElementById('bestModel');
        const latestForecastEl = document.getElementById('latestForecast');
        
        if (totalForecastsEl) {
            totalForecastsEl.textContent = savedModels.length;
        }
        if (activeModelsEl) {
            activeModelsEl.textContent = savedModels.length;
        }
        
        if (savedModels.length > 0) {
            // Find the best model (first one for now)
            if (bestModelEl) {
                bestModelEl.textContent = savedModels[0].method;
            }
            if (latestForecastEl) {
                latestForecastEl.textContent = new Date(savedModels[0].created_at).toLocaleDateString();
            }
        }
    }
    
        // Display forecast models in the list
    function displayForecastModels(models) {
        const modelsList = document.getElementById('forecastModelsList');
        
        if (!modelsList) {
            return; // Element doesn't exist, skip
        }
        
        if (models.length === 0) {
            modelsList.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>No forecast models yet</p>
                    <small>Create your first forecast to get started</small>
                </div>
            `;
        } else {
            modelsList.innerHTML = models.map(model => `
                <a href="#" class="list-group-item list-group-item-action" data-model-id="${model.id}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${model.name}</h6>
                        <small class="badge bg-primary">${model.method.toUpperCase()}</small>
                    </div>
                    <p class="mb-1 text-muted">${model.target_column}</p>
                    <small class="text-muted">Created: ${new Date(model.created_at).toLocaleDateString()}</small>
                </a>
            `).join('');
        }
    }

    // Open new forecast modal
    function openNewForecastModal() {
        if (!currentData || !currentData.data || currentData.data.length === 0) {
            showToast('Please upload data first', 'warning');
            return;
        }

        // Clear previous entries
        const nameInput = document.querySelector('input[name="name"]');
        if (nameInput) nameInput.value = '';
        
        const dateColumnSelect = document.querySelector('select[name="dateColumn"]');
        const targetColumnSelect = document.querySelector('select[name="targetColumn"]');
        
        // Clear options
        if (dateColumnSelect) {
            dateColumnSelect.innerHTML = '<option value="">Select date column</option>';
        }
        if (targetColumnSelect) {
            targetColumnSelect.innerHTML = '<option value="">Select target column</option>';
        }
        
        // Populate columns from current data with type filtering
        if (currentColumns && currentColumns.length > 0 && currentData && currentData.column_types) {
            currentColumns.forEach(column => {
                const columnType = currentData.column_types[column];
                
                // Only add date columns to date dropdown
                if (dateColumnSelect && (columnType === 'date' || columnType === 'datetime')) {
                    const dateOption = document.createElement('option');
                    dateOption.value = column;
                    dateOption.textContent = `${column} (${columnType})`;
                    dateColumnSelect.appendChild(dateOption);
                }
                
                // Only add numeric columns to target dropdown
                if (targetColumnSelect && columnType === 'numeric') {
                    const targetOption = document.createElement('option');
                    targetOption.value = column;
                    targetOption.textContent = `${column} (${columnType})`;
                    targetColumnSelect.appendChild(targetOption);
                }
            });
            
            // Add helpful messages if no appropriate columns found
            if (dateColumnSelect && dateColumnSelect.children.length === 1) {
                const noDateOption = document.createElement('option');
                noDateOption.disabled = true;
                noDateOption.textContent = 'No date columns found';
                dateColumnSelect.appendChild(noDateOption);
            }
            
            if (targetColumnSelect && targetColumnSelect.children.length === 1) {
                const noNumericOption = document.createElement('option');
                noNumericOption.disabled = true;
                noNumericOption.textContent = 'No numeric columns found';
                targetColumnSelect.appendChild(noNumericOption);
            }
        }

        // Reset form
        const form = document.getElementById('newForecastForm');
        if (form) {
            form.reset();
        }

        // Hide all parameter groups
        document.querySelectorAll('.parameter-group').forEach(group => {
            group.style.display = 'none';
        });

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('newForecastModal'));
        modal.show();
    }

    // Select forecast model from list
    function selectForecastModel(modelId) {
        const savedModels = JSON.parse(localStorage.getItem('forecastModels') || '[]');
        const model = savedModels.find(m => m.id === modelId);
        
        if (model) {
            // Update model details
            updateModelDetails(model);
            
            // Update chart if forecast data exists
            if (model.forecast_data) {
                updateForecastChartDisplay(model.forecast_data);
            }
            
            // Highlight selected model
            document.querySelectorAll('#forecastModelsList .list-group-item-action').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-model-id="${modelId}"]`).classList.add('active');
        }
    }

    // Update model details panel
    function updateModelDetails(model) {
        const parametersDiv = document.getElementById('modelParameters');
        const metricsDiv = document.getElementById('modelMetrics');
        
        // Update parameters
        if (parametersDiv) {
            let parametersHtml = `<div class="text-start">`;
            parametersHtml += `<p><strong>Method:</strong> ${model.method.toUpperCase()}</p>`;
            parametersHtml += `<p><strong>Target Column:</strong> ${model.target_column}</p>`;
            parametersHtml += `<p><strong>Date Column:</strong> ${model.date_column}</p>`;
            parametersHtml += `<p><strong>Forecast Period:</strong> ${model.period} days</p>`;
            
            if (model.parameters) {
                parametersHtml += `<p><strong>Parameters:</strong></p><ul>`;
                Object.entries(model.parameters).forEach(([key, value]) => {
                    parametersHtml += `<li>${key}: ${value}</li>`;
                });
                parametersHtml += `</ul>`;
            }
            parametersHtml += `</div>`;
            parametersDiv.innerHTML = parametersHtml;
        }
        
        // Update metrics
        if (metricsDiv) {
            if (model.metrics) {
                let metricsHtml = `<div class="text-start">`;
                Object.entries(model.metrics).forEach(([key, value]) => {
                    metricsHtml += `<p><strong>${key.toUpperCase()}:</strong> ${value.toFixed(4)}</p>`;
                });
                metricsHtml += `</div>`;
                metricsDiv.innerHTML = metricsHtml;
            } else {
                metricsDiv.innerHTML = '<p class="text-muted">No metrics available</p>';
            }
        }
    }

    async function handleGenerateForecast() {
        const form = document.getElementById('newForecastForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const formData = new FormData(form);
        const modelName = formData.get('name');
        const dateColumn = formData.get('dateColumn');
        const targetColumn = formData.get('targetColumn');
        const forecastMethod = formData.get('method');
        const forecastPeriod = parseInt(formData.get('period'));

        if (!dateColumn || !targetColumn) {
            showToast('Please select date and target columns', 'warning');
            return;
        }

        // Validate column types
        if (currentData && currentData.column_types) {
            const dateColumnType = currentData.column_types[dateColumn];
            const targetColumnType = currentData.column_types[targetColumn];
            
            if (dateColumnType !== 'date' && dateColumnType !== 'datetime') {
                showToast(`Selected date column '${dateColumn}' is not a date column (type: ${dateColumnType}). Please select a date column.`, 'warning');
                return;
            }
            
            if (targetColumnType !== 'numeric') {
                showToast(`Selected target column '${targetColumn}' is not numeric (type: ${targetColumnType}). Please select a numeric column for forecasting.`, 'warning');
                return;
            }
        }

        if (!currentData || !currentData.data || !currentData.data.length) {
            showToast('No data available for forecasting', 'warning');
            return;
        }
        
        // Collect method-specific parameters
        let parameters = {};
        switch (forecastMethod) {
            case 'lstm':
                parameters = {
                    sequence_length: parseInt(formData.get('lstmSequenceLength') || 10),
                    epochs: parseInt(formData.get('lstmEpochs') || 50)
                };
                break;
            case 'arima':
                parameters = {
                    p: parseInt(formData.get('arimaP') || 1),
                    d: parseInt(formData.get('arimaD') || 1),
                    q: parseInt(formData.get('arimaQ') || 1)
                };
                break;
            case 'prophet':
                parameters = {
                    growth: formData.get('prophetGrowth') || 'linear',
                    seasonality_mode: formData.get('prophetSeasonality') || 'additive'
                };
                break;
        }

        // Show loading state
        const generateForecastBtn = document.getElementById('generateForecastModalBtn');
        generateForecastBtn.disabled = true;
        generateForecastBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';

        // Debug: Log the request data
        const requestData = {
            name: modelName,
            date_column: dateColumn,
            target_column: targetColumn,
            method: forecastMethod,
            period: forecastPeriod,
            parameters: parameters,
            historical_data: currentData.data
        };
        
        console.log('Sending forecast request:', {
            name: modelName,
            date_column: dateColumn,
            target_column: targetColumn,
            method: forecastMethod,
            period: forecastPeriod,
            parameters: parameters,
            data_sample: currentData.data.slice(0, 3), // First 3 rows for debugging
            total_rows: currentData.data.length
        });

        try {
            const response = await fetch('/forecasting/api/generate-forecast/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(requestData)
            });

            const responseData = await response.json();

            if (!response.ok) {
                console.error('API Error Response:', responseData);
                throw new Error(responseData.message || 'Failed to generate forecast');
            }

            if (responseData.status === 'success') {
                // Create model object for local storage
                const newModel = {
                    id: Date.now().toString(),
                    name: modelName,
                    method: forecastMethod,
                    date_column: dateColumn,
                    target_column: targetColumn,
                    period: forecastPeriod,
                    parameters: parameters,
                    created_at: new Date().toISOString(),
                    forecast_data: responseData.data,
                    metrics: responseData.data.metrics || {}
                };

                // Save to local storage
                const savedModels = JSON.parse(localStorage.getItem('forecastModels') || '[]');
                savedModels.unshift(newModel); // Add to beginning
                localStorage.setItem('forecastModels', JSON.stringify(savedModels));

                // Close the modal
                const newForecastModal = document.getElementById('newForecastModal');
                const modal = bootstrap.Modal.getInstance(newForecastModal);
                if (modal) {
                    modal.hide();
                }

                // Update the forecast view
                loadForecastModels();
                
                // Auto-select the new model
                setTimeout(() => {
                    selectForecastModel(newModel.id);
                }, 100);
                
                showToast('Forecast generated successfully!', 'success');
            } else {
                throw new Error(responseData.message || 'Failed to generate forecast');
            }
        } catch (error) {
            showToast('Error generating forecast: ' + error.message, 'danger');
        } finally {
            // Restore loading state
            generateForecastBtn.disabled = false;
            generateForecastBtn.innerHTML = '<i class="fas fa-play me-2"></i>Generate Forecast';
        }
    }

    // Update forecast chart display (for new UI)
    function updateForecastChartDisplay(data) {
        const chartContainer = document.getElementById('forecastChartContainer');
        const canvas = document.getElementById('forecastChart');
        
        // Show chart, hide placeholder
        chartContainer.querySelector('.text-center').style.display = 'none';
        canvas.style.display = 'block';
        
        // Update chart
        updateForecastChart(data);
    }

    function updateForecastChart(data) {
        const ctx = document.getElementById('forecastChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (forecastChart instanceof Chart) {
            forecastChart.destroy();
        }

        // Extract data - handle different data formats
        let dates, forecasts, lowerBounds, upperBounds;
        
        if (data.dates && data.forecast && data.confidence_intervals) {
            // New format
            dates = data.dates;
            forecasts = data.forecast.map(d => typeof d === 'object' ? d.forecast : d);
            lowerBounds = data.confidence_intervals.lower;
            upperBounds = data.confidence_intervals.upper;
        } else if (data.forecast && Array.isArray(data.forecast)) {
            // Alternative format
            forecasts = data.forecast;
            dates = forecasts.map((_, index) => `Day ${index + 1}`);
            lowerBounds = forecasts.map(val => val * 0.95); // Dummy confidence intervals
            upperBounds = forecasts.map(val => val * 1.05);
        } else {
            showToast('Invalid forecast data format', 'danger');
            return;
        }

        // Create the chart
        forecastChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Forecast',
                        data: forecasts,
                        borderColor: 'rgb(102, 126, 234)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    },
                    {
                        label: 'Confidence Interval',
                        data: upperBounds,
                        borderColor: 'rgba(102, 126, 234, 0.2)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: '+1',
                        tension: 0.4
                    },
                    {
                        label: 'Lower Bound',
                        data: lowerBounds,
                        borderColor: 'rgba(102, 126, 234, 0.2)',
                        fill: false,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Forecast Results',
                        font: {
                            size: 16
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y.toFixed(2);
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Units Sold'
                        }
                    }
                }
            }
        });

        // Switch to forecast view after generating forecast
        switchView('forecast');

        // Display metrics
        const metricsDiv = document.getElementById('forecast-metrics');
        if (metricsDiv) {
            metricsDiv.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Forecast Metrics</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <p><strong>RMSE:</strong> ${data.metrics.rmse.toFixed(2)}</p>
                                <p><strong>MAE:</strong> ${data.metrics.mae.toFixed(2)}</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>R²:</strong> ${data.metrics.r2.toFixed(4)}</p>
                                <p><strong>MAPE:</strong> ${data.metrics.mape.toFixed(2)}%</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Model ID:</strong> ${data.model_id}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    async function generateVisualization() {
        if (!currentData) {
            showToast('Please upload data first', 'warning');
            return;
        }

        // Get selected grouping options
        const groupByColumn = document.getElementById('groupByColumn').value;
        const aggregationMethod = document.getElementById('aggregationMethod').value;

        if (!groupByColumn) {
            showToast('Please select a column to group by', 'warning');
            return;
        }

        // Find numeric column for Y-axis
        const numericColumns = currentData.columns.filter(col => 
            currentData.column_types[col] === 'numeric'
        );

        if (numericColumns.length === 0) {
            showToast('No numeric columns found for visualization', 'warning');
            return;
        }

        try {
            const response = await fetch('/business/api/visualization-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    x_axis: groupByColumn,
                    y_axis: numericColumns[0], // Use first numeric column
                    group_by_x_axis: true,
                    aggregation_method: aggregationMethod,
                    filters: currentFilters
                })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                updateVisualization(data.data, groupByColumn, numericColumns[0]);
                switchView('visualization');
                showToast('Visualization generated successfully!', 'success');
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            showToast('Error generating visualization: ' + error.message, 'danger');
        }
    }

    function updateVisualization(data, xAxis, yAxis) {
        const ctx = document.getElementById('visualizationChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (visualizationChart instanceof Chart) {
            visualizationChart.destroy();
        }

        visualizationChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.x,
                datasets: [{
                    label: yAxis,
                    data: data.y,
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `${yAxis} by ${xAxis}`,
                        font: {
                            size: 16
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: yAxis
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: xAxis
                        }
                    }
                }
            }
        });
    }

    // Load saved file function
    async function loadSavedFile(fileId) {
        try {
            showLoading('Loading saved file...');
            
            const response = await fetch('/business/api/load-saved-file/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ file_id: fileId })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                currentData = data.data;
                displayDataPreview(data.data);
                setupColumns(data.data.columns, data.data.column_types);
                showPanels();
                showToast('File loaded successfully!', 'success');
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            showToast('Error loading file: ' + error.message, 'danger');
        } finally {
            hideLoading();
        }
    }

    // Delete saved file function
    async function deleteSavedFile(fileId) {
        if (!confirm('Are you sure you want to delete this file?')) {
            return;
        }

        try {
            const response = await fetch('/business/api/delete-saved-file/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ file_id: fileId })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                showToast('File deleted successfully!', 'success');
                // Reload the page to update saved files list
                window.location.reload();
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            showToast('Error deleting file: ' + error.message, 'danger');
        }
    }

    // Utility functions
    function showToast(message, type = 'info') {
        // Create and show toast notification
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        
        const toast = document.createElement('div');
        toast.className = `toast show align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1055';
        document.body.appendChild(container);
        return container;
    }

    function showLoading(message = 'Loading...') {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-overlay';
        loadingDiv.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
        loadingDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        loadingDiv.style.zIndex = '1060';
        loadingDiv.innerHTML = `
            <div class="card">
                <div class="card-body text-center">
                    <div class="spinner-border text-primary mb-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>${message}</div>
                </div>
            </div>
        `;
        document.body.appendChild(loadingDiv);
    }

    function hideLoading() {
        const loadingDiv = document.getElementById('loading-overlay');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Drag and Drop Functions
    function allowDrop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.add('drag-over');
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.dataset.column);
        ev.dataTransfer.setData("type", ev.target.dataset.type);
    }

    function drop(ev, dropZone) {
        ev.preventDefault();
        ev.currentTarget.classList.remove('drag-over');
        
        const columnName = ev.dataTransfer.getData("text");
        const columnType = ev.dataTransfer.getData("type");
        
        if (!columnName) return;
        
        // Clear existing content in drop zone
        const dropZoneElement = document.getElementById(dropZone === 'x-axis' ? 'xAxisDropZone' : 
                                                        dropZone === 'y-axis' ? 'yAxisDropZone' : 'colorDropZone');
        const droppedElement = document.getElementById(dropZone === 'x-axis' ? 'xAxisColumn' : 
                                                      dropZone === 'y-axis' ? 'yAxisColumn' : 'colorColumn');
        
        // Hide placeholder text
        const placeholderText = dropZoneElement.querySelector('.text-muted');
        const placeholderIcon = dropZoneElement.querySelector('.fas');
        if (placeholderText) placeholderText.style.display = 'none';
        if (placeholderIcon) placeholderIcon.style.display = 'none';
        
        // Show dropped column
        droppedElement.style.display = 'block';
        droppedElement.innerHTML = `
            <span>${columnName}</span>
            <button class="remove-btn" onclick="removeDroppedColumn('${dropZone}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Store the dropped column data
        droppedElement.dataset.column = columnName;
        droppedElement.dataset.type = columnType;
        
        // Add fade-in animation
        droppedElement.classList.add('fade-in');
    }

    function removeDroppedColumn(dropZone) {
        const dropZoneElement = document.getElementById(dropZone === 'x-axis' ? 'xAxisDropZone' : 
                                                        dropZone === 'y-axis' ? 'yAxisDropZone' : 'colorDropZone');
        const droppedElement = document.getElementById(dropZone === 'x-axis' ? 'xAxisColumn' : 
                                                      dropZone === 'y-axis' ? 'yAxisColumn' : 'colorColumn');
        
        // Show placeholder text
        const placeholderText = dropZoneElement.querySelector('.text-muted');
        const placeholderIcon = dropZoneElement.querySelector('.fas');
        if (placeholderText) placeholderText.style.display = 'inline';
        if (placeholderIcon) placeholderIcon.style.display = 'inline';
        
        // Hide dropped column
        droppedElement.style.display = 'none';
        droppedElement.innerHTML = '';
        
        // Clear stored data
        delete droppedElement.dataset.column;
        delete droppedElement.dataset.type;
    }

    function populateAvailableColumns() {
        if (!currentData || !currentData.columns) return;
        
        const availableColumns = document.getElementById('availableColumns');
        availableColumns.innerHTML = '';
        
        currentData.columns.forEach(column => {
            const columnType = currentData.column_types[column];
            const columnElement = document.createElement('div');
            columnElement.className = 'list-group-item draggable-column';
            columnElement.draggable = true;
            columnElement.dataset.column = column;
            columnElement.dataset.type = columnType;
            columnElement.ondragstart = drag;
            columnElement.ondragend = function(ev) {
                ev.currentTarget.classList.remove('drag-over');
            };
            
                    const badgeColor = columnType === 'numeric' ? 'bg-success' :
                           columnType === 'date' ? 'bg-info' : 'bg-secondary';
        const customBadgeStyle = columnType === 'numeric' ? 'background: linear-gradient(135deg, #10b981, #059669) !important;' :
                                columnType === 'date' ? 'background: linear-gradient(135deg, #667eea, #764ba2) !important;' : 
                                'background: linear-gradient(135deg, #718096, #4a5568) !important;';
            
            columnElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>${column}</span>
                    <span class="badge ${badgeColor} column-type-badge">${columnType}</span>
                </div>
            `;
            
            availableColumns.appendChild(columnElement);
        });
    }

    async function generateChart() {
        const xAxisColumn = document.getElementById('xAxisColumn');
        const yAxisColumn = document.getElementById('yAxisColumn');
        const colorColumn = document.getElementById('colorColumn');
        const chartType = document.getElementById('chartType').value;
        const aggregationMethod = document.getElementById('vizAggregationMethod').value;
        
        if (!xAxisColumn.dataset.column || !yAxisColumn.dataset.column) {
            showToast('Please select both X-axis and Y-axis columns', 'warning');
            return;
        }
        
        if (!currentData) {
            showToast('No data available for visualization', 'warning');
            return;
        }
        
        try {
            showLoading('Generating chart...');
            
            const response = await fetch('/business/api/visualization-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    x_axis: xAxisColumn.dataset.column,
                    y_axis: yAxisColumn.dataset.column,
                    category: colorColumn.dataset.column || null,
                    group_by_x_axis: true,
                    aggregation_method: aggregationMethod,
                    filters: currentFilters
                })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                updateVisualizationChart(data.data, chartType, {
                    xAxis: xAxisColumn.dataset.column,
                    yAxis: yAxisColumn.dataset.column,
                    category: colorColumn.dataset.column
                });
                showChartStats(data.data);
                showToast('Chart generated successfully!', 'success');
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            showToast('Error generating chart: ' + error.message, 'danger');
        } finally {
            hideLoading();
        }
    }

    function updateVisualizationChart(data, chartType, columns) {
        const ctx = document.getElementById('visualizationChart').getContext('2d');
        const chartContainer = document.getElementById('chartContainer');
        const placeholder = chartContainer.querySelector('.text-center');
        
        // Hide placeholder and show chart
        if (placeholder) placeholder.style.display = 'none';
        document.getElementById('visualizationChart').style.display = 'block';
        
        // Destroy existing chart if it exists
        if (visualizationChart instanceof Chart) {
            visualizationChart.destroy();
        }

        // Prepare chart configuration based on type
        let chartConfig = {
            type: chartType,
            data: {
                labels: data.x,
                datasets: [{
                    label: columns.yAxis,
                    data: data.y,
                    backgroundColor: generateColors(data.x.length, 0.6),
                    borderColor: generateColors(data.x.length, 1),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `${columns.yAxis} by ${columns.xAxis}`,
                        font: {
                            size: 16
                        }
                    },
                    legend: {
                        display: chartType === 'pie' || chartType === 'doughnut'
                    }
                },
                scales: chartType !== 'pie' && chartType !== 'doughnut' ? {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: columns.yAxis
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: columns.xAxis
                        }
                    }
                } : {}
            }
        };

        // Special handling for line charts
        if (chartType === 'line' || chartType === 'area') {
            chartConfig.data.datasets[0].fill = chartType === 'area';
            chartConfig.data.datasets[0].tension = 0.4;
        }

        visualizationChart = new Chart(ctx, chartConfig);
        
        // Show additional controls
        document.getElementById('downloadChartBtn').style.display = 'inline-block';
        document.getElementById('fullScreenChartBtn').style.display = 'inline-block';
    }

    function generateColors(count, alpha = 1) {
        const colors = [
            `rgba(54, 162, 235, ${alpha})`,
            `rgba(255, 99, 132, ${alpha})`,
            `rgba(255, 206, 86, ${alpha})`,
            `rgba(75, 192, 192, ${alpha})`,
            `rgba(153, 102, 255, ${alpha})`,
            `rgba(255, 159, 64, ${alpha})`,
            `rgba(199, 199, 199, ${alpha})`,
            `rgba(83, 102, 255, ${alpha})`,
            `rgba(255, 99, 255, ${alpha})`,
            `rgba(99, 255, 132, ${alpha})`
        ];
        
        const result = [];
        for (let i = 0; i < count; i++) {
            result.push(colors[i % colors.length]);
        }
        return result;
    }

    function showChartStats(data) {
        const statsPanel = document.getElementById('chartStatsPanel');
        const statsContent = document.getElementById('chartStatsContent');
        
        const total = data.y.reduce((sum, val) => sum + val, 0);
        const average = total / data.y.length;
        const max = Math.max(...data.y);
        const min = Math.min(...data.y);
        
        statsContent.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <div class="text-center">
                        <h5 class="text-primary">${total.toFixed(2)}</h5>
                        <small class="text-muted">Total</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h5 class="text-success">${average.toFixed(2)}</h5>
                        <small class="text-muted">Average</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h5 class="text-warning">${max.toFixed(2)}</h5>
                        <small class="text-muted">Maximum</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h5 class="text-info">${min.toFixed(2)}</h5>
                        <small class="text-muted">Minimum</small>
                    </div>
                </div>
            </div>
        `;
        
        statsPanel.style.display = 'block';
    }

    function clearChartConfiguration() {
        // Clear all drop zones
        removeDroppedColumn('x-axis');
        removeDroppedColumn('y-axis');
        removeDroppedColumn('color');
        
        // Reset chart type
        document.getElementById('chartType').value = 'bar';
        document.getElementById('vizAggregationMethod').value = 'sum';
        
        // Hide chart and show placeholder
        const chartContainer = document.getElementById('chartContainer');
        const placeholder = chartContainer.querySelector('.text-center');
        if (placeholder) placeholder.style.display = 'block';
        document.getElementById('visualizationChart').style.display = 'none';
        
        // Hide additional controls
        document.getElementById('downloadChartBtn').style.display = 'none';
        document.getElementById('fullScreenChartBtn').style.display = 'none';
        document.getElementById('chartStatsPanel').style.display = 'none';
        
        // Destroy chart
        if (visualizationChart instanceof Chart) {
            visualizationChart.destroy();
        }
        
        showToast('Chart configuration cleared', 'info');
    }

    function downloadChart() {
        if (!visualizationChart) {
            showToast('No chart to download', 'warning');
            return;
        }
        
        const link = document.createElement('a');
        link.download = 'chart.png';
        link.href = visualizationChart.toBase64Image();
        link.click();
        
        showToast('Chart downloaded successfully!', 'success');
    }

    // Remove the old generateVisualization function and replace with the new one
    function generateVisualization() {
        switchView('visualization');
        populateAvailableColumns();
    }

    // Add drag leave event to remove drag-over class
    document.addEventListener('dragleave', function(e) {
        if (e.target.classList.contains('drop-zone')) {
            e.target.classList.remove('drag-over');
        }
    });

    // Make currentData available globally for forecast functionality
    window.currentData = currentData;
</script>
{% endblock %} 